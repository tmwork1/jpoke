# Copilot 指示

## プロジェクト概要
- jpoke はポケモンシングルバトル対戦シミュレータで、戦闘ロジックの開発に使用される
- ポケモンの利用規約に抵触する可能性があるため、AI ボットの開発は保留中

## アーキテクチャ

### イベント駆動パターン
- [`core/event.py`](src/jpoke/core/event.py) で `EventManager` が中核。Battle の各フェーズでイベント発火
- 特性・アイテム・技の効果は `Handler` 登録で実装。同期実行、優先度制御あり
- `EventContext` で source/target/attacker/defender のロール管理
- **Handler の構造**:
  - **func**: 実行する関数（HandlerReturn を返す）
  - **subject_spec**: `"role:side"` 形式で発動条件を指定
    - role: "source", "target", "attacker", "defender"
    - side: "self"（自分側）または "foe"（相手側）
  - **source_type**: "ability" | "item" | "move" | "ailment"（ハンドラの出典）
  - **log**: LogPolicy で自動ログ出力の制御（"always" | "on_success" | "on_failure" | "never"）
  - プロパティ `Handler.role`, `Handler.side` で分解取得可能

### HandlerReturn
- ハンドラ関数は `HandlerReturn` NamedTuple を返す（型チェック/自動ログに使用）
- `HandlerReturn(success: bool, value: Any = None, control: HandlerResult | None = None)`
  - success: 処理が成功したか
  - value: 後続の修正計算に使う値（ダメージ補正など）
  - control: イベント制御フラグ（STOP_HANDLER など）

### Handler 派生クラス
- [`handlers/ability.py`](src/jpoke/handlers/ability.py): `AbilityHandler` 継承で source_type="ability" + log="on_success" デフォルト
- [`handlers/item.py`](src/jpoke/handlers/item.py): `ItemHandler` 継承で source_type="item" + log="on_success" デフォルト
- [`handlers/ailment.py`](src/jpoke/handlers/ailment.py): `AilmentHandler` 継承で source_type="ailment" + log="always" デフォルト
- [`handlers/volatile.py`](src/jpoke/handlers/volatile.py): `VolatileHandler` 継承で source_type="volatile" + log="on_success" デフォルト
- data 配下では派生クラスを使用し、冗長な引数指定を削減

### 主要フロー
1. **Battle.advance_turn()** → Players の選択受け取り → ターン実行
2. **ダメージ計算** - [`core/damage.py`](src/jpoke/core/damage.py) で種族値・努力値・ランク・修正を集約
3. **フィールド効果** - [`core/field_manager.py`](src/jpoke/core/field_manager.py) の WeatherManager, TerrainManager, SideFieldManager で状態管理
4. **深いコピー** - Battle は deepcopy 対応（乱数隠蔽含む）
   - [`utils/copy_utils.py`](src/jpoke/utils/copy_utils.py) の `fast_copy()` で効率的なコピー実装

### Battle クラスの責務分離
Battle クラスは複数のマネージャークラスに責務を委譲し、単一責任原則を実現:

- **[`core/move_executor.py`](src/jpoke/core/move_executor.py)**: `MoveExecutor` - 技の実行
  - `run_move()`: 技の発動、イベント発火、ダメージ適用
  - `check_hit()`: 命中判定
  - `command_to_move()`: コマンドから技オブジェクトへの変換
  
- **[`core/switch_manager.py`](src/jpoke/core/switch_manager.py)**: `SwitchManager` - 交代処理
  - `run_switch()`: 基本交代処理（退場・入場・イベント発火）
  - `run_initial_switch()`: バトル開始時の初期交代
  - `run_interrupt_switch()`: 割り込み交代（だっしゅつパック、だっしゅつボタン等）
  - `run_faint_switch()`: 瀕死による交代
  - `has_interrupt()`, `override_interrupt()`: 割り込みフラグ管理

- **[`core/turn_controller.py`](src/jpoke/core/turn_controller.py)**: `TurnController` - ターン進行管理
  - `init_turn()`: ターン初期化とターン番号のインクリメント
  - `run_selection()`: ポケモン選出処理
  - `advance_turn()`: ターン進行のエントリポイント（公開API）
  - `_process_turn_phases()`: ターン進行の内部処理（コマンド処理、技発動、交代のオーケストレーション）
  - `calc_TOD_score()`: Time Over Death スコア計算（生存ポケモン数 + HP割合）
  - `judge_winner()`: 勝敗判定（TODスコアによる判定も含む）

- **Battle クラス本体**: 状態管理、ログ、ダメージ計算、クエリメソッドなど
  - 各マネージャーへの**ファサードメソッド**を提供（委譲パターン）
  - 例: `battle.run_move()` → `battle.move_executor.run_move()`
  - 例: `battle.advance_turn()` → `battle.turn_controller.advance_turn()`

### Logger の設計
- [`core/logger.py`](src/jpoke/core/logger.py) で `Logger` クラスが **データ管理層**として存在
- **3種類のログ**:
  - `EventLog`: ターン中のイベント・アクション・メッセージ（技の使用、特性の発動など）
  - `CommandLog`: プレイヤーが選択したコマンド（リプレイ再生用）
  - `DamageLog`: ダメージ発生時の状況（将来の拡張用）
- **責務の分離**:
  - **Logger**: ログの記録・取得・永続化のみ（データ管理層）
  - **Battle**: プレイヤー情報へのアクセス、表示ロジック（ビジネス層）
- **ログのアクセス方法**:
  - Battle クラス経由: `battle.add_event_log(source, text)` (推奨)
    - `source` は `Player | Pokemon` を受け取り、`Battle.get_player_idx()` でインデックスに変換
  - Logger 直接: `battle.logger.add_event_log(turn, idx, text)` (低レベルAPI)
- **ログの取得**:
  - Battle 経由: `battle.get_event_logs(turn)` → `dict[Player, list[str]]` 形式
  - Logger 直接: `logger.get_event_logs(turn, idx)` → `list[str]` 形式
- **ログの出力**: `battle.print_logs(turn)` で整形出力（Battle が担当）
- **命名規則**:
  - ログクラス: `XxxLog` (frozen dataclass)
  - リスト: `xxx_logs`
  - 追加メソッド: `add_xxx_log(turn, idx, text)` (Logger) / `add_xxx_log(source, text)` (Battle)
  - 取得メソッド: `get_xxx_logs(turn, idx)` (Logger) / `get_xxx_logs(turn)` (Battle)
  - プレイヤーインデックス: `idx` (0 or 1)
- **Handler からのログ**:
  - `Handler.write_log()` が自動的に `battle.add_event_log()` を呼び出す
  - ハンドラ内で追加ログが必要な場合: `battle.add_event_log(pokemon, "メッセージ")`

### Pokemon クラスとステータス計算
- **[`model/pokemon.py`](src/jpoke/model/pokemon.py)**: `Pokemon` クラス - ポケモンのバトル状態と基本データを管理
  - **責務分離**: ステータス計算ロジックを `PokemonStats` クラスに委譲
  - **`_stats_manager`**: `PokemonStats` インスタンスでステータス計算を一元管理
  - **ライフサイクル**:
    - `init_game()`: ゲーム開始時の初期化（HP、状態異常、テラスタルなど）
    - `bench_reset()`: 場から引っ込んだときの状態リセット（ランク、フラグなど）
  - **場の出入り**:
    - `switch_in()`: イベントハンドラの登録（特性、持ち物、状態異常、揮発性状態）
    - `switch_out()`: イベントハンドラの解除
  - **状態管理**:
    - バトル状態: `hp`, `ailment`, `volatiles`, `rank`, `is_terastallized` など
    - 基本データ: `name`, `level`, `nature`, `ability`, `item`, `moves`
    - 一時状態: `executed_move`, `boosted_stat`, `choice_locked` など
  - **揮発性状態**: `volatiles: dict[str, Volatile]` で複数の揮発性状態を管理
    - `apply_volatile()`: 揮発性状態を付与（既存の同名状態があれば失敗）
    - `remove_volatile()`: 揮発性状態を解除
    - `check_volatile()`: 揮発性状態の存在確認

- **[`model/ailment.py`](src/jpoke/model/ailment.py)**: `Ailment` クラス - 状態異常の管理
  - **GameEffect 継承**: 特性、アイテムと同様にハンドラ登録機構を持つ
  - **単一インスタンス**: Pokemon ごとに 1 つの状態異常のみ（`self.ailment: Ailment`）
  - **自動公開**: 初期化時に `reveal()` を呼び、常に相手に公開される
  - **属性**:
    - `count`: 状態異常の継続ターン数（ねむり、もうどくなど）
  - **ライフサイクル**:
    - `init_game()` 不要（Pokemon が新規インスタンスを生成）
    - `bench_reset()`: count をリセット（状態異常自体は維持）

- **[`model/volatile.py`](src/jpoke/model/volatile.py)**: `Volatile` クラス - 揮発性状態の管理
  - **GameEffect 継承**: 状態異常と同様にハンドラ登録機構を持つ
  - **複数同時保持**: Pokemon に `volatiles: dict[str, Volatile]` で複数の状態を管理
  - **場限定**: ベンチに戻ると `bench_reset()` で辞書ごと消去される
  - **属性**:
    - `count`: 揮発性状態の継続ターン数（初期値指定可能）
    - `value`: 揮発性状態に紐づく数値（みがわりのHP等）
  - **メソッド**:
    - `is_active`: `count > 0` で状態が有効かを判定
    - `tick_up()`, `tick_down()`: カウンターの増減
  - **対応状態**: みがわり、アンコール、ちょうはつ、やどりぎのタネ、こんらん、メロメロなど 25 種類
  - **ライフサイクル**:
    - `bench_reset()` 不要（Pokemon が `volatiles` 辞書を新規作成）
    - `switch_out()` で全ての volatile のハンドラが解除される

- **[`model/stats.py`](src/jpoke/model/stats.py)**: `PokemonStats` クラス - ステータス計算専門
  - **calc_hp()**: HPの実数値計算（種族値、個体値、努力値、レベルから）
  - **calc_stat()**: HP以外のステータス実数値計算（性格補正含む）
  - **`PokemonStats`**: ステータス計算を一元管理
    - `_stats`: 実数値リスト `[HP, 攻撃, 防御, 特攻, 特防, 素早さ]`
    - `_indiv`: 個体値リスト
    - `_effort`: 努力値リスト
    - **`update_stats(level, base, nature)`**: ステータス再計算（戻り値なし）
      - レベル、種族値、個体値、努力値、性格補正から全ステータスを再計算
      - Pokemon 側で `keep_damage` ロジックを処理（被ダメージ量の保持）
    - **`set_stats_from_value()`**: 実数値から努力値を逆算（レベル50の8n調整想定）
    - **`set_effort_at()`**: 努力値を直接設定
    - **`_calculate_effort_from_stat()`**: 努力値逆算の内部ロジック
  - **分離のメリット**:
    - 単一責任原則: ステータス計算ロジックの独立
    - テスタビリティ: `PokemonStats` 単体でのユニットテスト可能
    - 再利用性: 他のコンテキストでも利用可能

### データ定義の構造
- **[`data/models.py`](src/jpoke/data/models.py)**: `AbilityData`, `ItemData`, `MoveData`, `AilmentData`, `VolatileData` などの dataclass 定義
  - `handlers`: `dict[Event, Handler]` でイベントごとのハンドラを登録
  - `flags`: 特性・アイテム・技の特殊フラグ（"unreproducible", "undeniable" など）
- **data 配下のファイル**: 各データの実装
  - [`data/ability.py`](src/jpoke/data/ability.py): `ABILITIES` 辞書で特性データ定義
  - [`data/item.py`](src/jpoke/data/item.py): `ITEMS` 辞書で持ち物データ定義
  - [`data/move.py`](src/jpoke/data/move.py): `MOVES` 辞書で技データ定義
  - [`data/ailment.py`](src/jpoke/data/ailment.py): `AILMENTS` 辞書で状態異常データ定義
  - [`data/volatile.py`](src/jpoke/data/volatile.py): `VOLATILES` 辞書で揮発性状態データ定義
    - `common_setup()`: 全ての volatile ハンドラに log_text を自動設定（名前を表示）
  - [`data/pokedex.py`](src/jpoke/data/pokedex.py): `pokedex` 辞書でポケモン種族値データ管理

## 命名規則

### utils/ ディレクトリ構成
プロジェクト全体で使用されるユーティリティ関数と型定義を提供:

- **[`utils/constants.py`](src/jpoke/utils/constants.py)**: ゲーム定数（性格補正、タイプ相性など）
  - `NATURE_MODIFIER`, `TYPE_MODIFIER`, `NATURES`, `TYPES`, `STATS`, `RANK_MIN`, `RANK_MAX`
- **[`utils/type_defs.py`](src/jpoke/utils/type_defs.py)**: 型エイリアス定義（Literal型）
  - `RoleSpec`, `EffectSource`, `LogPolicy`, `Stat`, `Type`, `Weather`, `Terrain`, `AilmentName`, `VolatileName` など
- **[`utils/enums/`](src/jpoke/utils/enums/)**: Enum定義（パッケージ化）
  - `Event`, `EventControl` - イベント種別とハンドラ制御
  - `Interrupt` - 割り込み処理（だっしゅつボタン等）
  - `DamageFlag` - ダメージ計算フラグ
  - `Command` - プレイヤーコマンド（MOVE, SWITCH, PASS）
- **[`utils/copy_utils.py`](src/jpoke/utils/copy_utils.py)**: オブジェクトコピー
  - `fast_copy()`: 特定のキーのみ deepcopy する高速コピー
  - `recursive_copy()`: 完全な deepcopy
- **[`utils/file_io.py`](src/jpoke/utils/file_io.py)**: ファイルI/O、リソース管理
  - `resource_path()`: リソースファイルパス取得
  - `download()`: URLからファイルダウンロード
  - `load_last_update()`, `save_last_update()`: 更新ログ管理
  - `needs_update()`: 今日更新済みか確認
  - `find_most_similar()`: 類似文字列検索（日本語対応）
- **[`utils/string_utils.py`](src/jpoke/utils/string_utils.py)**: 文字列処理（日本語特化）
  - `japanese_char_ratio()`: 日本語文字の割合計算
  - `to_upper_japanese()`: 日本語文字を大文字化
  - `remove_dakuten()`: 濁点・半濁点を除去
- **[`utils/test_utils.py`](src/jpoke/utils/test_utils.py)**: テストヘルパー
  - `CustomPlayer`: テスト用プレイヤークラス
  - `start_battle()`: バトル初期化ヘルパー
  - `can_switch()`: 交代可能かチェック

### bool 型変数・メソッド
- **状態確認**: `is_` で始める（例: `is_active`, `is_floating()`, `is_trapped()`）
- **所有確認**: `has_` で始める（例: `has_type()`, `has_interrupt()`）
- **能力確認**: `can_` で始める（例: `can_terastallize()`）

### ハンドラ関数のパラメータ命名
- ロール/サイド指定: `xxx_spec` 形式（例: `target_spec`, `source_spec`）
- `RoleSpec` 型で常に `"role:side"` 形式（例: `"target:foe"`, `"source:self"`）
- `EventContext.resolve_role()` メソッドで `RoleSpec` から `Pokemon` インスタンスを解決
- `Handler.resolve_subject()` で `subject_spec` から subject を解決

### Logger 関連の命名
- **ログクラス**: `XxxLog` 形式（例: `EventLog`, `CommandLog`）、frozen dataclass で不変
- **ログリスト**: `xxx_logs` 形式（例: `event_logs`, `command_logs`）
- **追加メソッド**: 
  - Logger: `add_xxx_log(turn, idx, text)` - 低レベルAPI
  - Battle: `add_xxx_log(source, text)` - 高レベルAPI（source から idx を自動取得）
- **取得メソッド**: 
  - Logger: `get_xxx_logs(turn, idx)` → `list[str]` - 単一プレイヤー用
  - Battle: `get_xxx_logs(turn)` → `dict[Player, list[str]]` - 全プレイヤー用
- **インデックス**: `idx` でプレイヤーインデックス（0 or 1）を表す
- **辞書変換**: `to_dict()` でログエントリを辞書化

## 関連ファイル解読順序
1. [`utils/type_defs.py`](src/jpoke/utils/type_defs.py) - RoleSpec, EffectSource, LogPolicy, VolatileName などの型定義
2. [`utils/enums/`](src/jpoke/utils/enums/) - Event, Command, Interrupt などの列挙型定義
3. [`utils/constants.py`](src/jpoke/utils/constants.py) - ゲーム定数（性格補正、タイプ相性など）
4. [`model/stats.py`](src/jpoke/model/stats.py) - PokemonStats クラスとステータス計算関数
5. [`model/effect.py`](src/jpoke/model/effect.py) - GameEffect 基底クラス（Ability, Item, Ailment, Volatile の共通基盤）
6. [`model/ailment.py`](src/jpoke/model/ailment.py) - Ailment クラス（状態異常管理）
7. [`model/volatile.py`](src/jpoke/model/volatile.py) - Volatile クラス（揮発性状態管理）
8. [`model/pokemon.py`](src/jpoke/model/pokemon.py) - Pokemon クラスとバトル状態管理
9. [`core/event.py`](src/jpoke/core/event.py) - Handler, EventContext, EventManager
10. [`core/move_executor.py`](src/jpoke/core/move_executor.py) - 技実行処理
11. [`core/switch_manager.py`](src/jpoke/core/switch_manager.py) - 交代処理
12. [`core/turn_controller.py`](src/jpoke/core/turn_controller.py) - ターン進行処理
13. [`core/battle.py`](src/jpoke/core/battle.py) - Battle クラスと各マネージャークラスのファサード
14. [`data/models.py`](src/jpoke/data/models.py) - AbilityData, ItemData, MoveData, VolatileData などの構造定義
15. [`handlers/ability.py`](src/jpoke/handlers/ability.py) + [`handlers/item.py`](src/jpoke/handlers/item.py) + [`handlers/ailment.py`](src/jpoke/handlers/ailment.py) + [`handlers/volatile.py`](src/jpoke/handlers/volatile.py) - Handler 派生と汎用関数
16. [`handlers/common.py`](src/jpoke/handlers/common.py) - 汎用ハンドラ関数（modify_hp, modify_stat など）
17. [`data/volatile.py`](src/jpoke/data/volatile.py) - 揮発性状態データ定義（VOLATILES 辞書）

## Handler 定義パターン（data/ 配下）

Handler の定義は以下の優先順位で選択してください:

1. **名前付き関数** (最推奨): handlers/ 配下で定義し、デバッグを容易にする
2. **partial による引数固定**: handlers/common.py の汎用関数を再利用
3. **Lambda** (最小限): 単純な条件チェックのみ（複雑なロジックは禁止）

### 1. 名前付き関数の使用（最推奨）

```python
# handlers/ability.py で定義
def じりょく(battle: Battle, ctx: EventContext, value: Any):
    result = ctx.source.has_type("はがね")
    return HandlerReturn(True, result)

# data/ability.py で参照
"じりょく": AbilityData(
    handlers={
        Event.ON_CHECK_TRAPPED: h.AbilityHandler(
            h.じりょく,
            subject_spec="source:foe",
            log="never",
        )
    }
),
```

**利点**: スタックトレースで関数名表示、IDE ジャンプ可、個別テスト可

### 2. partial による引数固定

```python
"いかく": AbilityData(
    handlers={
        Event.ON_SWITCH_IN: h.AbilityHandler(
            partial(common.modify_stat, stat="A", v=-1, target_spec="source:foe", source_spec="source:self"),
            subject_spec="source:self",
        )
    }
),
```

**利点**: handlers/common.py の汎用関数を再利用、コード重複を削減

### 3. Lambda（単純な条件のみ）

```python
Event.ON_SWITCH_IN: h.AbilityHandler(
    lambda *args: HandlerReturn(True),
    subject_spec="source:self",
    log="always",
)
```

**注意**: 複雑なロジックを Lambda で実装すると、スタックトレースで `<lambda>` としか表示されず、デバッグが困難になります。

## テスト実行

```bash
python tests/run_tests.py              # 全テスト実行
python tests/run_tests.py "move_*.py"  # パターンマッチ
```

- [`tests/run_tests.py`](tests/run_tests.py) は async テストランナー
- 各ファイルで `test()` 関数を定義
- [`.vscode/launch.json`](.vscode/launch.json) で個別テストのデバッグ設定

## 開発時のポイント

- **Handler の戻り値** - ハンドラ関数は **必ず HandlerReturn 型** を返す
- **自動ログ** - Handler.log に基づいて EventManager で自動ログ出力
- **Handler 優先度** - `priority` パラメータで実行順序制御（デフォルト: 100）
  - priority が **小さい順**、同じなら**素早さが大きい順**に実行
  - `EventManager._sort_handlers()` で `(priority, -speed)` でソート
  - 素早さは `battle.calc_effective_speed()` で直接取得
- **参照更新** - deepcopy 後は `update_reference()` で内部参照を新オブジェクトに付け替え
  - Battle の deepcopy では `move_executor`, `switch_manager`, `turn_controller` も keys_to_deepcopy に含める
  - 各マネージャークラスは `update_reference(battle)` メソッドを実装し、Battle の `_update_reference()` で呼び出される
- **RoleSpec** - `"role:side"` 形式が必須（スタンドアロン値は不可）
- **派生クラス活用** - data/ 定義では AbilityHandler/ItemHandler/AilmentHandler を使い冗長さを削減
- **LogPolicy** - `"always"` (常にログ), `"on_success"` (成功時), `"on_failure"` (失敗時), `"never"` (非表示)
- **マネージャークラスへのアクセス** - Battle 経由のファサードメソッド推奨
  - `battle.run_move()` → `battle.move_executor.run_move()` に委譲
  - `battle.run_switch()` → `battle.switch_manager.run_switch()` に委譲
  - `battle.advance_turn()` → `battle.turn_controller.advance_turn()` に委譲
- **デバッグ** - Lambda は `<lambda>` としか表示されないため、handlers/ で名前付き関数を定義することを推奨
- **ステータス計算** - Pokemon クラスは `_stats_manager` (PokemonStats) に委譲
  - `update_stats()` は戻り値なし（被ダメージ保持は Pokemon 側で処理）
  - ステータス計算の詳細は [`model/stats.py`](src/jpoke/model/stats.py) を参照
  - `keep_damage=True` で `pokemon.update_stats()` を呼ぶと、レベルアップ等で最大HP変化時も被ダメージ割合を保持
