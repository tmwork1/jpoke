# Copilot 指示

## プロジェクト概要
- jpoke はポケモンシングルバトル対戦シミュレータで、戦闘ロジックの開発に使用される
- ポケモンの利用規約に抵触する可能性があるため、AI ボットの開発は保留中

## アーキテクチャ

### イベント駆動パターン
- [core/event.py](src/jpoke/core/event.py) で `EventManager` が中核。Battle の各フェーズでイベント発火
- 特性・アイテム・技の効果は `Handler` 登録で実装。同期実行、優先度制御あり
- `EventContext` で source/target/attacker/defender のロール管理
- **Handler の subject と subject_spec**:
  - **subject**: ハンドラを所有・発動させるポケモン（またはプレイヤー） = 「誰のハンドラか」
  - **subject_spec**: どの状況で発動するかを `"role:side"` 形式で指定
    - `role`: "source", "target", "attacker", "defender" のいずれか
    - `side`: "self"（自分側）または "foe"（相手側）
  - プロパティ `Handler.role` と `Handler.side` で分解して取得可能
  - `_match()` メソッドでイベントコンテキストのロールが subject と一致するかを確認

### 主要フロー
1. **Battle.execute()** → Players の選択受け取り → ターン実行
2. **ダメージ計算** - [core/damage.py](src/jpoke/core/damage.py) で種族値・努力値・ランク・修正を集約
3. **フィールド効果** - WeatherManager, TerrainManager, SideFieldManager で状態管理
4. **深いコピー** - Battle は deepcopy 対応（乱数隠蔽含む）

## 命名規則
### bool 型変数・メソッド
- **状態確認**: `is_` で始める（例: `is_active`, `is_floating()`, `is_trapped()`）
- **所有確認**: `has_` で始める（例: `has_type()`, `has_interrupt()`）
- **能力確認**: `can_` で始める（例: `can_terastallize()`）

### ハンドラ関数のパラメータ命名
- ロール/サイド指定: `xxx_spec` 形式（例: `target_spec`, `source_spec`）
  - `RoleSpec` 型で常に `"role:side"` 形式を使用
  - [handlers/base.py](src/jpoke/handlers/base.py) の `_resolve_role()` で解決

## 関連ファイル解読順序
1. [core/battle.py](src/jpoke/core/battle.py) - Battle クラスと turn ループ
2. [core/event.py](src/jpoke/core/event.py) - Handler 登録・実行フロー
3. [data/models.py](src/jpoke/data/models.py) - 各データの構造定義
4. [handlers/base.py](src/jpoke/handlers/base.py) - reveal/modify_hp/apply_ailment など汎用ヘルパー
5. [utils/types.py](src/jpoke/utils/types.py) - RoleSpec, Factor, LogPolicy などの型定義

## テスト実行
```bash
python tests/run_tests.py              # 全テスト実行
python tests/run_tests.py "move_*.py"  # パターンマッチ
```
- [tests/run_tests.py](tests/run_tests.py) は async テストランナー。`test()` 関数を各ファイルで定義
- 特性・技・アイテムは [tests/](tests/) の個別ファイルで検証

## 開発時のポイント
- **Handler 優先度** - `Handler.priority` で実行順序制御（高いほど先）
- **EventContext ロール** - "source"(所有者), "target"(対象), "attacker"(攻撃), "defender"(被攻撃)
- **参照更新** - deepcopy 後は `update_reference()` で内部参照を新オブジェクトに付け替え
- **ログ出力** - [handlers/base.py](src/jpoke/handlers/base.py) の `reveal()` で技・特性・アイテムを公開
- **RoleSpec 使用** - ハンドラ関数では常に `xxx_spec="role:side"` 形式で指定（`"source:self"` など）
- **Handler 定義** - data/ 配下での Handler 呼び出しでは必ず `subject_spec` パラメータを指定
- **状態異常管理** - Ailment は Pokemon が switch_in/switch_out で handler を管理（Ability/Item と同様）