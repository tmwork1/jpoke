````instructions
# Copilot 指示

## 基本方針

- **ポケモンの仕様は第9世代（スカーレット・バイオレット）を参照する**
- **第9世代で実装されていない技・アイテム・特性・ポケモンなどは、実装を見送る**

---

## 実装指示

- ユーザーからの要求は最初にマネージャーが引き受ける
- `.github/instructions/agents/workflow.md` に従い実装を進める
- 不明点は合理的な選択肢を推測して継続し、作業を完遂(テストは全パス)することを優先する
- ユーザーの承認を待たずにファイルの作成・編集・削除を直接実行する
- **タスク完了後は必ずダッシュボードを更新し、知識を指示書・README.md に反映する**
  1. `python -m jpoke.utils.dashboard` を実行
  2. README.md の実装状況を更新
  3. 得られた知識を該当する指示書に追記

---

## クイックリファレンス

### プロジェクト概要
- **jpoke**: ポケモンシングルバトル対戦シミュレータ
- **目的**: 戦闘ロジックの開発検証
- **状態**: AI ボット開発は保留中

### 核心概念
1. **イベント駆動**: `EventManager` が中核（[`core/event.py`](src/jpoke/core/event.py)）
2. **Handler**: 効果は全て Handler で実装（[`handlers/`](src/jpoke/handlers/)）
3. **RoleSpec**: `"role:side"` 形式で対象指定（例: `"source:self"`, `"target:foe"`）
   - **重要**: ダメージ計算系イベントでは `"attacker:self"`, `"defender:self"` を使用
   - その他のイベントでは `"source:self"`, `"target:self"` を使用
4. **HandlerReturn**: 必ず `HandlerReturn(success, value, control)` を返す

### プロジェクト構造
```
src/jpoke/
├── core/       # バトルシステム中核
├── model/      # Pokemon状態管理
├── data/       # データ定義（特性・技・アイテム）
├── handlers/   # ハンドラ実装
└── utils/      # ユーティリティ
```

### 重要ファイル
- [`core/event.py`](src/jpoke/core/event.py) - イベント駆動システム
- [`core/battle.py`](src/jpoke/core/battle.py) - Battle ファサード
- [`core/damage.py`](src/jpoke/core/damage.py) - ダメージ計算（4096基準）
- [`model/pokemon.py`](src/jpoke/model/pokemon.py) - Pokemon クラス
- [`data/ability.py`](src/jpoke/data/ability.py) - 特性データ定義
- [`tests/test_utils.py`](tests/test_utils.py) - テストユーティリティ
- [`tests/field.py`](tests/field.py) - フィールド効果テスト

---

## テスト実装のベストプラクティス

### フィールド効果のテスト
- **補正値の検証**: イベントシステムを使って補正値を直接検証する
  - `ON_CALC_POWER_MODIFIER`: 技威力補正（4096基準）
  - `ON_CALC_DAMAGE_MODIFIER`: ダメージ補正（4096基準）
- **補正計算の基準値**: すべて4096基準で計算される
  - 例: 1.5倍補正 → `4096 * 1.5 = 6144`
  - 例: 0.5倍補正 → `4096 * 0.5 = 2048`
- **浮動小数点数の比較**: `abs(actual - expected) < 0.01` で誤差を許容

### テストヘルパー関数
- `start_battle()`: バトル初期化（天候・地形・フィールドを指定可能）
- `tick_fields()`: フィールド効果のカウントダウン
- `assert_field_active()`: フィールドの有効性を検証
- `get_field_count()`: フィールドの残りカウントを取得

### フィールドパラメータの一貫性
- `weather`: タプル `(天候名, カウント)`
- `terrain`: タプル `(地形名, カウント)`
- `ally_side_field`: 辞書 `{名前: レイヤー数}`
- `foe_side_field`: 辞書 `{名前: レイヤー数}`
- `global_field`: 辞書 `{名前: カウント}`
- `ally_volatile`: 辞書 `{名前: カウント}`
- `foe_volatile`: 辞書 `{名前: カウント}`

---

## ドキュメント構成

**必ず最初に [`.github/instructions/_README.md`](.github/instructions/_README.md) を読んでください。**

```
.github/instructions/
├── _README.md              # 読む順序・全体ガイド
├── project_context.md      # プロジェクト背景（15分）
├── architecture.md         # 詳細アーキテクチャ（30分）
└── agents/                 # エージェントプロンプト
    ├── workflow.md         # ワークフロー全体
    ├── 05_research.md      # 仕様調査
    ├── 00_orchestrator.md  # 全体計画
    ├── 10_planner.md       # タスク分解
    ├── 20_architect.md     # 設計
    ├── 30_coder.md         # 実装
    ├── 40_tester.md        # テスト
    ├── 50_reviewer.md      # レビュー
    └── 60_domain_expert.md # Pokemon仕様確認
```

---

## 新機能実装フロー

1. [`.github/instructions/agents/workflow.md`](.github/instructions/agents/workflow.md) で全体確認
2. [`agents/05_research.md`](.github/instructions/agents/05_research.md) で仕様調査
3. 各エージェント（Research → Orchestrator → Planner → Architect → Coder → Tester → Reviewer → Domain Expert）で実装

---

## 詳細情報

すべての詳細は **`.github/instructions/`** を参照：

- **プロジェクト背景**: [`.github/instructions/project_context.md`](.github/instructions/project_context.md)
- **アーキテクチャ詳細**: [`.github/instructions/architecture.md`](.github/instructions/architecture.md)
- **ワークフロー**: [`.github/instructions/agents/workflow.md`](.github/instructions/agents/workflow.md)
````
