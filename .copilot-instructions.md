````instructions
# Copilot 指示

## 基本方針

- **ポケモンの仕様は第9世代（スカーレット・バイオレット）を参照する**
- **第9世代で実装されていない技・アイテム・特性・ポケモンなどは、実装を見送る**

---

## 実装指示

### 基本フロー
1. **Manager (MGR)** がユーザーリクエストを受け付け
2. [`.github/instructions/agents/workflow.md`](.github/instructions/agents/workflow.md) に従って各エージェントに業務を割り当て
3. 各エージェントは **発言の先頭に役職識別子を付ける**（下記参照）
4. 不明点は合理的な選択肢を推測して継続し、**作業を完遂（全テストパス）することを優先**
5. ユーザーの承認を待たずにファイルの作成・編集・削除を直接実行

### タスク完了後の必須作業
以下を**必ず実行**してプロジェクトの知識を蓄積：

1. `python -m jpoke.utils.dashboard` を実行してダッシュボード更新
2. [README.md](README.md) の実装状況を更新
3. 得られた知識を該当する指示書（`.github/instructions/agents/*.md`）に追記

### エージェント発言規則

各エージェントは発言の先頭に役職識別子を付けること：

| 識別子 | 役職名（英語） | 役職名（日本語） |
|--------|--------------|----------------|
| **MGR** | Project Manager | プロジェクトマネージャー |
| **RSC** | Research Specialist | リサーチ専門家 |
| **PLN** | Planning Specialist | 計画専門家 |
| **ARC** | Architecture Specialist | 設計専門家 |
| **COD** | Coding Specialist | 実装専門家 |
| **TST** | Testing Specialist | テスト専門家 |
| **RVW** | Code Review Specialist | コードレビュー専門家 |
| **DOM** | Domain Expert | ポケモン仕様専門家 |

**例**:
```
MGR: ユーザーリクエストを受け付けました。リサーチ専門家に調査を依頼します。
RSC: 特性「かたやぶり」の仕様を調査します...
PLN: タスクを3つのサブタスクに分解します...
ARC: データモデルの設計を行います...
COD: handlers/ability.py に新しいハンドラを追加します...
TST: 状態異常のテストケースを作成します...
RVW: コード品質をレビューします...
DOM: ポケモン仕様との整合性を確認します...
```

---

## クイックリファレンス

### プロジェクト概要
- **jpoke**: ポケモンシングルバトル対戦シミュレータ
- **目的**: 戦闘ロジックの開発検証
- **状態**: AI ボット開発は保留中

### 核心概念
1. **イベント駆動**: `EventManager` が中核（[`core/event.py`](src/jpoke/core/event.py)）
2. **Handler**: 効果は全て Handler で実装（[`handlers/`](src/jpoke/handlers/)）
3. **RoleSpec**: `"role:side"` 形式で対象指定（例: `"source:self"`, `"target:foe"`）
   - **重要**: ダメージ計算系イベントでは `"attacker:self"`, `"defender:self"` を使用
   - その他のイベントでは `"source:self"`, `"target:self"` を使用
4. **HandlerReturn**: 必ず `HandlerReturn(success, value, control)` を返す

### プロジェクト構造
```
src/jpoke/
├── core/       # バトルシステム中核
├── model/      # Pokemon状態管理
├── data/       # データ定義（特性・技・アイテム）
├── handlers/   # ハンドラ実装
└── utils/      # ユーティリティ
```

### 重要ファイル
- [`core/event.py`](src/jpoke/core/event.py) - イベント駆動システム
- [`core/battle.py`](src/jpoke/core/battle.py) - Battle ファサード
- [`core/damage.py`](src/jpoke/core/damage.py) - ダメージ計算（4096基準）
- [`model/pokemon.py`](src/jpoke/model/pokemon.py) - Pokemon クラス
- [`data/ability.py`](src/jpoke/data/ability.py) - 特性データ定義
- [`tests/test_utils.py`](tests/test_utils.py) - テストユーティリティ
- [`tests/field.py`](tests/field.py) - フィールド効果テスト

---

## テスト実装のベストプラクティス

### フィールド効果のテスト
- **補正値の検証**: イベントシステムを使って補正値を直接検証する
  - `ON_CALC_POWER_MODIFIER`: 技威力補正（4096基準）
  - `ON_CALC_DAMAGE_MODIFIER`: ダメージ補正（4096基準）
- **補正計算の基準値**: すべて4096基準で計算される
  - 例: 1.5倍補正 → `4096 * 1.5 = 6144`
  - 例: 0.5倍補正 → `4096 * 0.5 = 2048`
- **浮動小数点数の比較**: `abs(actual - expected) < 0.01` で誤差を許容

### テストヘルパー関数
- `start_battle()`: バトル初期化（天候・地形・フィールドを指定可能）
- `tick_fields()`: フィールド効果のカウントダウン
- `assert_field_active()`: フィールドの有効性を検証
- `get_field_count()`: フィールドの残りカウントを取得

### フィールドパラメータの一貫性
- `weather`: タプル `(天候名, カウント)`
- `terrain`: タプル `(地形名, カウント)`
- `ally_side_field`: 辞書 `{名前: レイヤー数}`
- `foe_side_field`: 辞書 `{名前: レイヤー数}`
- `global_field`: 辞書 `{名前: カウント}`
- `ally_volatile`: 辞書 `{名前: カウント}`
- `foe_volatile`: 辞書 `{名前: カウント}`

---

## ドキュメント構成

**必ず最初に [`.github/instructions/_README.md`](.github/instructions/_README.md) を読んでください。**

```
.github/instructions/
├── _README.md              # 読む順序・全体ガイド
├── project_context.md      # プロジェクト背景（15分）
├── architecture.md         # 詳細アーキテクチャ（30分）
└── agents/                 # エージェントプロンプト
    ├── workflow.md         # ワークフロー全体
    ├── 05_research.md      # 仕様調査
    ├── 00_orchestrator.md  # 全体計画
    ├── 10_planner.md       # タスク分解
    ├── 20_architect.md     # 設計
    ├── 30_coder.md         # 実装
    ├── 40_tester.md        # テスト
    ├── 50_reviewer.md      # レビュー
    └── 60_domain_expert.md # Pokemon仕様確認
```

---

## 新機能実装フロー

1. [`.github/instructions/agents/workflow.md`](.github/instructions/agents/workflow.md) で全体確認
2. [`agents/05_research.md`](.github/instructions/agents/05_research.md) で仕様調査
3. 各エージェント（Research → Orchestrator → Planner → Architect → Coder → Tester → Reviewer → Domain Expert）で実装

---

## 詳細情報

すべての詳細は **`.github/instructions/`** を参照：

- **プロジェクト背景**: [`.github/instructions/project_context.md`](.github/instructions/project_context.md)
- **アーキテクチャ詳細**: [`.github/instructions/architecture.md`](.github/instructions/architecture.md)
- **ワークフロー**: [`.github/instructions/agents/workflow.md`](.github/instructions/agents/workflow.md)
````
