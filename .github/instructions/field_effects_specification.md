# フィールド効果の仕様書

ポケモン対戦シミュレータにおけるフィールド効果の実装仕様書

**最終更新日:** 2026年2月1日

---

## 目次

1. [フィールドの分類](#フィールドの分類)
2. [天候 (Weather)](#1-天候-weather)
3. [地形 (Terrain)](#2-地形-terrain)
4. [グローバルフィールド (GlobalField)](#3-グローバルフィールド-globalfield)
5. [サイドフィールド (SideField)](#4-サイドフィールド-sidefield)
6. [実装上の注意事項](#実装上の注意事項)

---

## フィールドの分類

フィールド効果は以下の4つのカテゴリに分類されます：

1. **天候 (Weather)** - `Weather` 型（排他的）
2. **地形 (Terrain)** - `Terrain` 型（排他的）
3. **グローバルフィールド (GlobalField)** - `GlobalField` 型（複数同時可）
4. **サイドフィールド (SideField)** - `SideField` 型（複数同時可）

---

## 1. 天候 (Weather)

天候は排他的で、バトル全体に影響します。`WeatherManager` で管理されます。

### 1.1 はれ（晴れ）

**基本効果:**
- ほのおタイプの技の威力が1.5倍
- みずタイプの技の威力が0.5倍
- かみなり・ぼうふうの命中率が50%に低下
- こおり状態が自然解凍されやすくなる

**特殊効果:**
- ソーラービーム・ソーラーブレードが溜めなしで使える
- せいちょうの効果が2段階上昇に強化
- あさのひざしなど天候回復技の回復量が2/3に増加

**ターン延長アイテム:** あついいわ（8ターン）

**継続ターン数:** 5ターン（通常）

---

### 1.2 あめ（雨）

**基本効果:**
- みずタイプの技の威力が1.5倍
- ほのおタイプの技の威力が0.5倍
- かみなり・ぼうふうが必中になる

**特殊効果:**
- ソーラービーム・ソーラーブレードの威力が0.5倍
- あさのひざしなど天候回復技の回復量が1/4に減少

**ターン延長アイテム:** しめったいわ（8ターン）

**継続ターン数:** 5ターン（通常）

---

### 1.3 すなあらし（砂嵐）

**基本効果:**
- ターン終了時、いわ・じめん・はがねタイプ以外のポケモンに最大HPの1/16のダメージ
- いわタイプのポケモンの特防が1.5倍

**特殊効果:**
- ソーラービーム・ソーラーブレードの威力が0.5倍
- あさのひざしなど天候回復技の回復量が1/4に減少

**ターン延長アイテム:** さらさらいわ（8ターン）

**継続ターン数:** 5ターン（通常）

**実装状況:** 
- ダメージ処理は `すなあらし_apply_damage` ハンドラで実装済み
- 特防上昇効果は未実装

---

### 1.4 ゆき（雪）

**基本効果:**
- こおりタイプのポケモンの防御が1.5倍
- ふぶきが必中になる
- オーロラベールが使用可能になる

**特殊効果:**
- ソーラービーム・ソーラーブレードの威力が0.5倍
- あさのひざしなど天候回復技の回復量が1/4に減少

**注意:**
- 第9世代で「あられ」から「ゆき」に変更され、ダメージ効果が削除されました

**ターン延長アイテム:** つめたいいわ（8ターン）

**継続ターン数:** 5ターン（通常）

---

## 2. 地形 (Terrain)

地形は排他的で、バトル全体に影響します。地面に接していないポケモン（ひこうタイプ、特性ふゆう）には効果がありません。`TerrainManager` で管理されます。

### 2.1 エレキフィールド

**基本効果:**
- でんきタイプの技の威力が1.3倍（使用者が地面に接している場合のみ）
- 地面に接しているポケモンはねむり状態にならない（既にねむり状態のポケモンも目覚める）

**ターン延長アイテム:** グランドコート（8ターン）

**継続ターン数:** 5ターン（通常）

---

### 2.2 グラスフィールド

**基本効果:**
- くさタイプの技の威力が1.3倍（使用者が地面に接している場合のみ）
- ターン終了時、地面に接しているポケモンのHPが最大HPの1/16回復
- じしん・マグニチュード・じならしの威力が0.5倍

**ターン延長アイテム:** グランドコート（8ターン）

**継続ターン数:** 5ターン（通常）

**実装状況:**
- `グラスメイカー` 特性で発動処理の例が実装済み

---

### 2.3 サイコフィールド

**基本効果:**
- エスパータイプの技の威力が1.3倍（使用者が地面に接している場合のみ）
- 地面に接しているポケモンは先制技の対象にならない

**ターン延長アイテム:** グランドコート（8ターン）

**継続ターン数:** 5ターン（通常）

---

### 2.4 ミストフィールド

**基本効果:**
- ドラゴンタイプの技の威力が0.5倍（対象が地面に接している場合のみ）
- 地面に接しているポケモンは状態異常・こんらんにならない

**ターン延長アイテム:** グランドコート（8ターン）

**継続ターン数:** 5ターン（通常）

---

## 3. グローバルフィールド (GlobalField)

グローバルフィールドは複数同時に有効化可能で、バトル全体に影響します。`GlobalFieldManager` で管理されます。

### 3.1 じゅうりょく（重力）

**基本効果:**
- 命中率が5/3倍になる
- 一撃必殺技が必中になる
- ひこうタイプ、特性ふゆうのポケモンも地面技の対象になる
- そらをとぶ・とびはねる・でんじふゆう・テレキネシスなどが使用不可
- フリーフォール状態のポケモンが地面に落ちる

**継続ターン数:** 5ターン

---

### 3.2 トリックルーム

**基本効果:**
- 素早さの順序が逆転する（遅いポケモンから行動）
- 優先度は通常通り適用される

**継続ターン数:** 5ターン

**実装上の注意:**
- 素早さ計算時に考慮する必要がある
- `speed_calculator.py` での実装が必要

---

## 4. サイドフィールド (SideField)

サイドフィールドは片方のプレイヤー側の場にのみ影響し、複数同時に有効化可能です。`SideFieldManager` で管理されます。

### 4.1 リフレクター

**基本効果:**
- 物理技のダメージを0.5倍に軽減（ダブルバトルでは2/3倍）
- かわらわりやサイコファング、すりぬけ特性で無効化

**継続ターン数:** 5ターン（通常）、8ターン（ひかりのねんど所持時）

**実装状況:**
- `リフレクター` ハンドラで一部実装済み

---

### 4.2 ひかりのかべ

**基本効果:**
- 特殊技のダメージを0.5倍に軽減（ダブルバトルでは2/3倍）
- かわらわりやサイコファング、すりぬけ特性で無効化

**継続ターン数:** 5ターン（通常）、8ターン（ひかりのねんど所持時）

---

### 4.3 しんぴのまもり

**基本効果:**
- 状態異常にならない（既に状態異常のポケモンは治らない）
- こんらんは防げない

**継続ターン数:** 5ターン（通常）、8ターン（ひかりのねんど所持時）

---

### 4.4 おいかぜ

**基本効果:**
- 素早さが2倍になる

**継続ターン数:** 4ターン

---

### 4.5 まきびし

**基本効果:**
- ポケモン交代時にダメージ
  - 1層: 最大HPの1/8
  - 2層: 最大HPの1/6
  - 3層: 最大HPの1/4
- ひこうタイプ、特性ふゆうには無効

**スタック:** 最大3層まで重ねがけ可能

---

### 4.6 どくびし

**基本効果:**
- ポケモン交代時に状態異常付与
  - 1層: どく状態
  - 2層: もうどく状態
- ひこうタイプ、特性ふゆうには無効
- どくタイプが交代で出ると消滅

**スタック:** 最大2層まで重ねがけ可能

---

### 4.7 ステルスロック

**基本効果:**
- ポケモン交代時にいわタイプ相性に応じたダメージ
  - 効果抜群（4倍）: 最大HPの1/2
  - 効果抜群（2倍）: 最大HPの1/4
  - 等倍: 最大HPの1/8
  - 効果今ひとつ（1/2倍）: 最大HPの1/16
  - 効果今ひとつ（1/4倍）: 最大HPの1/32

**スタック:** 重ねがけ不可

---

### 4.8 ねばねばネット

**基本効果:**
- ポケモン交代時に素早さランク-1
- ひこうタイプ、特性ふゆうには無効

**スタック:** 重ねがけ不可

---

### 4.9 オーロラベール

**基本効果:**
- リフレクターとひかりのかべの両方の効果を持つ
- 物理技・特殊技のダメージを0.5倍に軽減（ダブルバトルでは2/3倍）
- ゆき（雪）天候時のみ使用可能

**継続ターン数:** 5ターン（通常）、8ターン（ひかりのねんど所持時）

---

## 実装上の注意事項

### イベントタイミング

フィールド効果は以下のイベントで処理されます：

- **`ON_SWITCH_IN`**: フィールド発動（天候・地形変化特性など）
- **`ON_CHECK_DURATION`**: ターン延長アイテムの判定
- **`ON_TURN_END_2`**: ターン終了時のダメージ・回復処理
- **`ON_CALC_DAMAGE`**: ダメージ計算時の補正
- **`ON_CHECK_ACCURACY`**: 命中率判定
- **`ON_SWITCH_IN_AFTER`**: 交代後の効果（まきびし、ステルスロックなど）

### フィールド管理

- 排他的フィールド（天候・地形）は `ExclusiveFieldManager` で管理
- スタック可能フィールド（グローバル・サイド）は `StackableFieldManager` で管理
- フィールドデータは `data/field.py` で定義
- フィールドハンドラは `handlers/field.py` で実装

### ターン延長

ターン延長アイテムは `FieldData.turn_extension_item` で定義し、`ON_CHECK_DURATION` イベントで処理します。

**例: さらさらいわ**
```python
# data/item.py
FieldData(
    name="すなあらし",
    turn_extension_item="さらさらいわ",
    # ...
)
```

### 地面接地判定

地形効果の適用には地面接地判定が必要です：

- ひこうタイプのポケモンは非接地
- 特性「ふゆう」のポケモンは非接地
- でんじふゆう状態のポケモンは非接地
- テレキネシス状態のポケモンは非接地
- じゅうりょく状態では全て接地扱い

### ダメージ計算への影響

フィールド効果によるダメージ補正の優先順位：

1. 天候による威力補正（1.5倍 or 0.5倍）
2. 地形による威力補正（1.3倍）
3. リフレクター・ひかりのかべによる軽減（0.5倍 or 2/3倍）

### 実装ファイル

- **データ定義**: `src/jpoke/data/field.py`
- **モデル定義**: `src/jpoke/model/field.py`
- **ハンドラ**: `src/jpoke/handlers/field.py`
- **フィールド管理**: `src/jpoke/core/field_manager.py`

---

## 実装優先度

### 高優先度（対戦に必須）

1. 天候効果（はれ、あめ、すなあらし、ゆき）
2. 地形効果（エレキフィールド、グラスフィールド、サイコフィールド、ミストフィールド）
3. リフレクター、ひかりのかべ
4. ステルスロック、まきびし、どくびし

### 中優先度

1. トリックルーム
2. おいかぜ
3. しんぴのまもり
4. ねばねばネット
5. オーロラベール

### 低優先度

1. じゅうりょく
