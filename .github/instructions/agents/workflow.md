# ワークフロー ガイド

本ドキュメントは、複数のエージェント(Copilot Chat の異なる役割)を活用して、ポケモン対戦システムを効率的に開発するためのガイドである。

---

## 全体フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  ユーザー: 新機能のリクエスト                                            │
│  「XXX機能を追加したい」                                               │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Research Agent: 仕様調査                                              │
│  「Webから仕様をリサーチしました」                                     │
│                          ↓                                             │
│  ユーザー: リサーチ結果を確認                                           │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Orchestrator: 全体計画を作成                                          │
│  「以下のフローで進めます」                                            │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Planner: タスク分解                                                   │
│  「タスクをXXXに分割しました」                                        │
│                          ↓                                             │
│  ユーザー: コピペして確認                                              │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Architect: 設計案作成                                                 │
│  「技術設計は以下の通り」                                              │
│                          ↓                                             │
│  ユーザー: コピペして確認                                              │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Coder: コード実装                                                     │
│  「実装コードはこちら」                                                │
│                          ↓                                             │
│  ユーザー: コピペしてエディタに貼り付け、動作確認                       │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Tester: テスト実装                                                    │
│  「テストコードはこちら」                                              │
│                          ↓                                             │
│  ユーザー: テスト実行、全テスト成功か確認                              │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Reviewer: コードレビュー                                              │
│  「コード品質をチェックしました」                                      │
│  - 修正が必要な場合: Coderに修正依頼                                   │
│  - 問題ない場合: 次へ                                                  │
│                          ↓                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Domain Expert: ポケモン仕様確認                                       │
│  「仕様に適合しています」                                              │
│                          ↓                                             │
│  実装完了                                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 具体的な使い方

### Step 0: Research Agent で仕様調査(重要)

特性を大量に実装する場合は、この段階が最重要である。

1. VS Code の Copilot Chat を開く
   - Ctrl + Shift + I

2. 左パネルから `05_research` を選択
   - `.github/instructions/agents/` フォルダ内の `05_research.md`

3. **リサーチ対象を入力**
   ```
   【リサーチ対象リスト】
   以下の5つの特性について詳しく調べてください。
   
   1. テレパシー
   2. ダウンロード
   3. トレーシング
   4. シルヴディ
   5. フリーズドライ
   
   各特性について:
   - 基本効果と発動条件
   - 複数効果との相互作用
   - エッジケース・バグ情報
   - ゲーム内テスト方法
   
   を調べてください。
   ```

4. **Research Agent の出力を確認**
   - リサーチ結果が詳細に記載されている
   - 複数の出典が記載されている
   - 信頼度評価がある

5. **次のステップへ**
   - Orchestrator に「以下のリサーチ結果に基づいて実装を計画してください」と渡す

---

### Step 1: Orchestrator に相談する

1. VS Code の Copilot Chat を開く
   - Ctrl + Shift + I (または Chat アイコン)

2. 左パネルから `00_orchestrator` を選択
   - `.github/instructions/agents/` フォルダ内の `00_orchestrator.md` をプロンプトコンテキストに追加

3. **要件を入力**
   ```
   新しい特性「スキルスワップ」を追加したい。
   効果: ターン開始時に相手の特性を一時的に奪う
   ```

4. **Orchestrator の出力を確認**
   ```
   元の要件:
   - 新特性「スキルスワップ」を実装
   - ターン開始時に発動
   - 相手の特性を奪う
   
   推奨フロー:
   1. データモデル設計（ability.py）
   2. ハンドラー実装（handlers/ability.py）
   3. テスト実装
   ...
   ```

---

### Step 2: Planner に タスク分解を依頼

1. **Orchestrator の出力をコピー**

2. **Copilot Chat で `10_planner` を選択**

3. **Orchestrator の出力をペースト + 以下を追加**
   ```
   [Orchestrator の出力]
   
   このタスクを具体的なサブタスクに分解してください。
   ```

4. **Planner の出力例**
   ```
   ## タスク分解結果
   
   ### 実装の全体像
   
   | # | タスク | 対象ファイル | 難度 |
   |----|--------|------------|------|
   | 1 | Ability モデルに新フィールド追加 | src/jpoke/data/ability.py | 低 |
   | 2 | ハンドラー関数を実装 | src/jpoke/handlers/ability.py | 中 |
   | 3 | ターン開始時の発動タイミング組み込み | src/jpoke/core/turn_controller.py | 中 |
   | 4 | テスト実装 | tests/ability.py | 低 |
   ```

---

### Step 3: Architect に設計を依頼

1. **Planner の出力をコピー**

2. **Copilot Chat で `20_architect` を選択**

3. **Planner の出力をペースト + 以下を追加**
   ```
   [Planner の出力]
   
   このタスク計画に基づいて技術設計を作成してください。
   ```

4. **Architect の出力例**
   ```
   ## 実装設計
   
   ### タスク計画の概要
   [要点の整理]
   
   ### 詳細設計
   
   #### 1. データモデル設計
   
   ```python
   class Ability(BaseModel):
       # 既存フィールド
       id: str
       name: str
       
       # 新規フィールド
       swap_target_ability: Optional[str] = None  # 奪う特性
       duration_turns: int = 1  # 効果の持続ターン数
   ```
   
   #### 2. 既存コード連携
   
   | 対象ファイル | 変更内容 | 理由 |
   |...
   ```

---

### Step 4: Coder にコーディングを依頼

1. **Architect の出力をコピー**

2. **Copilot Chat で `30_coder` を選択**

3. **Architect の出力をペースト + 以下を追加**
   ```
   [Architect の出力]
   
   上記の設計に基づいてコードを実装してください。
   ```

4. **Coder の出力例**
   ```python
   ## 実装コード
   
   ### 実装内容
   
   #### 1. 新規モデル
   
   ```python
   # ファイル: src/jpoke/data/ability.py
   
   class Ability(BaseModel):
       ...
   ```
   
   #### 2. ハンドラー関数
   
   ```python
   # ファイル: src/jpoke/handlers/ability.py
   
   def swap_ability(...):
       ...
   ```
   ```

5. **生成されたコードをエディタに貼り付け**
   - 対象ファイルを VS Code で開く
   - コードをコピーして適切な箇所に貼り付け
   - 動作確認（インポート エラーなし、型ヒント OK など）

---

### Step 5: Tester にテスト実装を依頼

1. **Coder の出力をコピー**

2. **Copilot Chat で `40_tester` を選択**

3. **Coder の出力をペースト + 以下を追加**
   ```
   [Coder の出力]
   
   上記の実装に対して、包括的なテストコードを作成してください。
   ```

4. **Tester の出力例**
   ```python
   ## テスト実装
   
   ```python
   # ファイル: tests/ability.py
   
   class TestSkillSwap:
       def test_basic_swap(self):
           ...
       
       def test_duration(self):
           ...
   ```
   ```

5. **テストコードをエディタに貼り付け**
   ```bash
   pytest tests/ability.py -v
   ```

---

### Step 6: Reviewer にコードレビューを依頼

1. **Reviewer の出力をコピー（実装 + テストコード）**

2. **Copilot Chat で `50_reviewer` を選択**

3. **以下を入力**
   ```
   [実装コード + テストコード]
   
   上記の実装とテストに対してコードレビューしてください。
   品質、型安全性、セキュリティをチェックしてください。
   ```

4. **Reviewer の出力を確認**
   - ❌ **CRITICAL** 指摘がある場合
     - 指摘内容を Coder に渡して修正依頼
     - 修正後、再度 Reviewer にレビュー依頼
   
   - ✅ 問題ない場合
     - 次へ進む

---

### Step 7: Domain Expert に仕様確認を依頼

1. **Reviewer で OK が出たコードを準備**

2. **Copilot Chat で `60_domain_expert` を選択**

3. **以下を入力**
   ```
   [実装コード + テストコード]
   
   ポケモン対戦の仕様観点から、この実装をレビューしてください。
   ターン順序、複数効果の相互作用、ゲームバランスを確認してください。
   ```

4. **Domain Expert の出力を確認**
   - ✅ 問題ない
     - **実装完了、マージ可能**
   
   - ⚠️ 要修正
     - 指摘内容を Coder/Architect に渡して対応
   
   - ❌ 不適切
     - 設計段階へ巻き戻し

---

## 修正フロー

修正が必要な場合のフロー:

```
修正指摘あり
    ↓
Coder に修正内容を渡す
    ↓
修正実装を受け取る
    ↓
Tester に再度テスト
    ↓
Reviewer に再レビュー
    ↓
OK なら Domain Expert へ
```

---

## 効率的な使い方のコツ

### 1. コンテキストの活用

```
❌ やってはいけない:
「Coderエージェントでコード書いて」
（前の情報が失われる）

✅ 推奨:
[Architectの出力全体をコピペ]
「上記の設計に基づいて実装してください」
（コンテキストが繋がる）
```

### 2. 確認ポイント

各ステップで以下を確認:

| ステップ | 確認項目 |
|---------|---------|
| Planner | タスクの粒度は適切か、漏れはないか |
| Architect | 既存コード との矛盾はないか |
| Coder | エラーなく動作するか |
| Tester | テスト成功しているか |
| Reviewer | CRITICAL 指摘がないか |
| Domain Expert | ゲームバランスは OK か |

### 3. 手戻りを避けるコツ

- Planner の段階でしっかり確認（タスク漏れは後で大変）
- Architect で既存コード を必ず参考にする
- Coder の出力は動作確認してから Tester へ
- Reviewer で修正が出たら、修正内容を正確に Coder に伝える

---

## クイックスタート（小規模な機能の場合）

「Coder」と「Reviewer」だけで済ます場合:

```
1. Planner で簡単にタスク分解
   ↓
2. Coder に「以下のタスクを実装してください」
   ↓
3. Tester で簡単なテスト
   ↓
4. Reviewer で最終チェック
```

---

## 参考資料

- Research Agent (リサーチ担当): `.github/instructions/agents/05_research.md`
- Orchestrator (全体司令塔): `.github/instructions/agents/00_orchestrator.md`
- Planner (計画担当): `.github/instructions/agents/10_planner.md`
- Architect (設計担当): `.github/instructions/agents/20_architect.md`
- Coder (実装担当): `.github/instructions/agents/30_coder.md`
- Tester (テスト担当): `.github/instructions/agents/40_tester.md`
- Reviewer (レビュー担当): `.github/instructions/agents/50_reviewer.md`
- Domain Expert (ポケモン仕様): `.github/instructions/agents/60_domain_expert.md`
