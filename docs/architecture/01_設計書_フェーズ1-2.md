# 設計書 - フェーズ1-2（Architect 工程産物）

**作成者**: Architect（ARC）  
**入力**: Planner作成のタスク計画書  
**出力**: 詳細設計書・技術仕様  
**完成期限**: Week 2（計画完了後）

---

## 1. 技術的課題と対策

このセクションはPlanner作成タスク計画書の技術的実現性を精査し、実装前に解決すべき課題をまとめたもの。

### 1.1 既知の課題

| 課題 | 影響 | 対策 | 優先度 |
|------|------|------|--------|
| ポケモン体重情報未実装 | 特殊計算技(けたぐり等) | Task 2.2.3で追加 | 高 |
| `ON_CALC_CRITICAL`イベント未定義 | 急所判定システム | Task 2.1.1で新設 | 高 |
| 揮発状態の複数同時管理 | みがわり・あばれる等 | 既実装（検証済み） | 低 |
| 行動キャンセル機構 | ひるみ・無効化技 | TurnControllerで実装 | 中 |

### 1.2 リスク管理

| リスク | 確率 | 影響 | 対策 | 責任者 |
|--------|------|------|------|--------|
| 命中判定の複雑さで遅延 | 中 | 高 | Week 1-2で徹底テスト | TST |
| 特殊計算技の計算誤差 | 中 | 中 | 数学検証 + テスト拡充 | COD/TST |
| 優先度計算の同速処理 | 低 | 中 | ランダム数値化テスト | COD |

---

## 2. 実装順序と依存関係

### 2.1 実装順序の制約

```
2.1.1 急所判定 ────┐
                    ├─→ 2.2.1 能力ランク ───┐
2.1.2 命中判定 ─────┤                          ├─→ 統合テスト
                    ├─→ 2.2.2 状態異常 ────┤
2.1.3 優先度 ──────┤
                    ├─→ 2.2.3 特殊計算 ────┤
2.1.4 ひるみ ──────┤
2.1.5 HP吸収 ──────┤
2.1.6 反動 ────────┤
```

**説明**:
- 核心ロジック (2.1.1～2.1.6) が技追加効果 (2.2.1～2.2.4) の基盤となるため、先に実装
- 各技追加効果は独立して並行実装可能
- 統合テストはすべての技が揃ってから実施

### 2.2 既存の依存関係（実装時注意点）

| 依存元 | 依存先 | 状態 | 注意点 |
|--------|--------|------|--------|
| 急所判定 | FieldManager | 既実装・安定 | ON_CALC_CRITICAL イベントを新設 |
| 優先度計算 | イベントSystem | 既実装・安定 | ON_TURN_START での順序付け対応 |
| ダメージ計算 | DamageCalculator | 一部更新必要 | 急所判定・特殊計算技対応 |
| 技効果 | ハンドラシステム | 既実装・拡張対応 | 新規Handlerを handlers/move.py に追加 |

---

## 3. 詳細設計仕様

### 3.1 新規イベント定義（Task 2.1.1）

```python
# src/jpoke/utils/enums/event.py に追加
class BattleEvent(Enum):
    ON_CALC_CRITICAL = "on_calc_critical"  # 急所判定時に発火
```

**発火タイミング**: 
- ダメージ計算ステップで、命中判定後・ダメージ計算前
- 呼び出し元: `src/jpoke/core/damage.py` の `calculate_damage()` 関数

### 3.2 命中判定ロジック（Task 2.1.2）

**実装ファイル**: `src/jpoke/core/damage.py` (既存の hit_check 関数拡張)

**入力パラメータ**:
- `accuracy`: 技の命中率（1～100）
- `attacker_stats`: 攻撃側のランク調整値（+/-）
- `defender_stats`: 防御側のランク調整値（+/-）
- `weather`: 天候（雨時は命中率100%の技が存在）
- `terrain`: フィールド状態

**ランク補正計算**:
```
調整後命中率 = base_accuracy * (1 + attacker_rank * 0.33) * (1 - defender_rank * 0.25)
制約: 0.3 ≤ 調整後命中率 ≤ 1.0
```

### 3.3 優先度システム（Task 2.1.3）

**優先度の有効範囲**: -7 ～ +5

**実装ファイル**: `src/jpoke/core/speed_calculator.py` (優先度計算部分追加)

**優先度別の技**:
| 優先度 | 技例 |
|--------|------|
| +3 | しんそく |
| +2 | おうじゃのまえぶれ |
| +1 | でんこうせっか, はやおくり |
| 0 | 通常技 |
| -1 | ふきとばし |
| -7 | ほえる |

### 3.4 特殊計算技の体重依存式（Task 2.2.3）

**けたぐり威力計算**:
```python
def calc_ketaguiri_power(defender_weight: float) -> int:
    """
    defender_weight: kg単位
    戻り値: 技の威力 (20/40/60/80/100/120)
    """
    if defender_weight < 10.0: return 20
    elif defender_weight < 25.0: return 40
    elif defender_weight < 35.0: return 60
    elif defender_weight < 50.0: return 80
    elif defender_weight < 100.0: return 100
    else: return 120
```

**実装ファイル**: `src/jpoke/handlers/move.py` (新規Handler)

---

## 4. テスト設計仕様

### 4.1 テスト対象技・パターン一覧

**急所判定テスト**:
```python
# test_move.py に追加
def test_critical_hit_iwa_nadare():
    """いわなだれ: 30%高急所率"""
    # 100回実行して30%程度の急所率を確認
    critical_count = 0
    for _ in range(100):
        result = calc_critical_hit(move="iwa_nadare")
        if result: critical_count += 1
    assert 20 < critical_count < 40
```

**命中判定テスト**:
```python
def test_accuracy_check_rank_bonus():
    """命中率 + ランク補正"""
    # 攻撃側 +1 ランク、命中率90%の技
    adjusted_accuracy = calc_accuracy(90, attacker_rank=1)
    assert adjusted_accuracy > 0.9  # 約99%以上
```

### 4.2 テスト実行コマンド

```bash
# フェーズ1-2全テスト
python -m pytest tests/test_move.py tests/test_ability.py -v --tb=short

# カバレッジ確認
python -m pytest tests/ --cov=src/jpoke/handlers --cov=src/jpoke/core

# 特定テスト実行
python -m pytest tests/test_move.py::test_critical_hit_iwa_nadare -v
```

---

## 5. ドキュメンテーション計画

### 5.1 新規ドキュメント作成（Coder 完成後）

- `docs/instructions/核心ロジック実装ガイド.md` - ON_CALC_CRITICAL イベント・命中判定・優先度の実装パターン
- `docs/research/特殊計算技詳細分析.md` - 体重計算式の導出・検証
- `docs/checklist/フェーズ1-2チェックリスト.md` - 実装進捗管理表

### 5.2 既存ドキュメント更新

- `.github/instructions/architecture.md` - ON_CALC_CRITICAL イベント定義追加
- `docs/research/move_gen9.md` - 技分類の更新
- `src/jpoke/core/damage.py` の docstring - 命中判定ロジック説明追加

---

## 6. 完了後の進捗予測

### 実装率推移（フェーズ1-2完了時）

| 対象 | Phase 1-1 | Phase 1-2 完了時 | 増分 |
|------|-----------|-----------------|------|
| 技 | 10.7% (81/759) | 20～25% | +80～100技 |
| 特性 | 9.2% (15/163) | 15～18% | +10～15種 |
| アイテム | 13.8% (22/160) | 22～25% | +15～20種 |
| **総体** | **~10-11%** | **~15-18%** | **+5-7%** |

**注記**: 調査書データが確定したため目標値は見かけ上低下しているが、実装タスク数は不変（核心ロジック 6 + 技追加効果 4 + アイテム・特性 2 = 合計 12タスク）

---

## 7. Architect チェックリスト（自己検査用）

- [ ] 全12タスクの技術的実現性を確認
- [ ] 新規イベント定義がイベントSystem と互換性を持つ
- [ ] 依存関係に循環参照がないか確認
- [ ] テスト設計が実装仕様をカバーしているか確認
- [ ] 既存コードとの統合ポイントを明確化
- [ ] リスク対応策が技術的に実現可能か確認
- [ ] Coder に向け、実装開始前に詳細仕様を共有

---

**設計書 Created**: 2026-02-04  
**Status**: Awaiting Coder Review  
**Next Step**: Coder による実装開始（Week 3）

