# 状態異常（Ailment）第9世代仕様

**調査日**: 2026年2月1日  
**対象世代**: 第9世代（スカーレット・バイオレット）  
**調査範囲**: まひ、やけど、ねむり、こおり

---

## 概要

第9世代における主要な状態異常4種類（まひ、やけど、ねむり、こおり）の仕様を調査。既存実装の「どく」「もうどく」と合わせて全6種類の状態異常の実装を完了。

---

## 1. まひ（Paralysis）

### 基本効果
- **素早さ**: 元の素早さの **1/2** に低下
- **行動制限**: 毎ターン **25%** の確率で行動不能（「しびれて うごけない!」）

### 第9世代での変更点
- 第7世代以降、素早さ低下が 1/4 → **1/2** に緩和

### 実装上の考慮事項
- イベント: `ON_CALC_SPEED` で素早さ計算時に補正
- イベント: `ON_BEFORE_ACTION` で行動前に25%チェック
- 行動不能判定は技選択後、実行前に行う
- **乱数**: `battle.random.random()` を使用（再現性保証のため）
- **テスト**: `battle.test_option.ailment_trigger_rate` で確率制御可能

### 参考資料
- [ポケモンWiki - まひ](https://wiki.xn--rckteqa2e.com/wiki/%E3%81%BE%E3%81%B2)

---

## 2. やけど（Burn）

### 基本効果
- **攻撃力**: 物理技の威力が **1/2** に低下
- **継続ダメージ**: 毎ターン終了時に最大HPの **1/16** のダメージ

### 第9世代での変更点
- 変更なし（第3世代から一貫）

### 実装上の考慮事項
- イベント: `ON_CALC_POWER_MODIFIER` で物理技のみ威力半減
  - 技カテゴリが「物理」の場合のみ適用
  - 「特殊」「変化」技には影響なし
- イベント: `ON_TURN_END_4` でダメージ処理
- 特性「こんじょう」などで攻撃力低下を無効化する場合あり

### 参考資料
- [ポケモンWiki - やけど](https://wiki.xn--rckteqa2e.com/wiki/%E3%82%84%E3%81%91%E3%81%A9)

---

## 3. ねむり（Sleep）

### 基本効果
- **行動制限**: 完全に行動不能
- **継続ターン**: **1〜3ターン** 後に自然回復（ねむり状態になったターンを含む）

### ターンカウント仕様
- ねむり状態になった時点でカウンターを1〜3のランダムに設定
- 毎ターン開始時にカウンターを -1
- カウンターが 0 になったら回復

### 第9世代での変更点
- 変更なし（従来通り1〜3ターン）

### 実装上の考慮事項
- イベント: `ON_BEFORE_ACTION` で行動前チェック
- カウンター管理: `ailment.count` で残りターン数を保持
- 特性「ぜったいねむり」などで永続的なねむり状態を実装可能

### 参考資料
- [ポケモンWiki - ねむり](https://wiki.xn--rckteqa2e.com/wiki/%E3%81%AD%E3%82%80%E3%82%8A)

---

## 4. こおり（Freeze）

### 基本効果
- **行動制限**: 完全に行動不能
- **回復確率**: 毎ターン **20%** の確率で自然回復

### 第9世代での変更点
- 変更なし（第1世代から一貫）

### 実装上の考慮事項
- イベント: `ON_BEFORE_ACTION` で行動前に20%回復チェック
- ほのおタイプの技を受けた場合の即座解除は別途実装が必要
  - `ON_BEFORE_DAMAGE` などでの追加処理
- **乱数**: `battle.random.random()` を使用（再現性保証のため）
- **テスト**: `battle.test_option.ailment_trigger_rate` で確率制御可能
- **状態解除**: `ailment.unregister_handlers()` + 新規 `Ailment()` インスタンス作成

### 特殊ケース
- こおりタイプのポケモンは第2世代以降こおり状態にならない
  - この制約は技の実装側で処理

### 参考資料
- [ポケモンWiki - こおり](https://wiki.xn--rckteqa2e.com/wiki/%E3%81%93%E3%81%8A%E3%82%8A)

---

## 実装マッピング

### イベントハンドラ対応表

| 状態異常 | イベント | ハンドラ関数 | 処理内容 |
|---------|---------|-------------|---------|
| まひ | ON_CALC_SPEED | `まひ_speed` | 素早さ → value // 2 |
| まひ | ON_BEFORE_ACTION | `まひ_action` | 25%で行動不能 |
| やけど | ON_CALC_POWER_MODIFIER | `やけど_power` | 物理技威力 → value // 2 |
| やけど | ON_TURN_END_4 | `やけど_damage` | HP -1/16 |
| ねむり | ON_BEFORE_ACTION | `ねむり_action` | カウント管理・行動不能 |
| こおり | ON_BEFORE_ACTION | `こおり_action` | 20%回復チェック・行動不能 |

### subject_spec の使い分け

- **自身への効果**: `"target:self"`
  - 素早さ計算、行動前チェックなど
- **攻撃者としての効果**: `"attacker:self"`
  - ダメージ計算系（やけどの物理技威力低下）

---

## テスト方針

### 基本テスト項目
1. **まひ**
   - ✅ 素早さが正確に1/2になるか
   - ⚠️ 25%行動不能（確率的テストのため複数回実行推奨）

2. **やけど**
   - ✅ 物理技のみ威力半減
   - ✅ 特殊技には影響なし
   - ✅ ターン終了時1/16ダメージ

3. **ねむり**
   - ✅ カウンター設定
   - ✅ カウンターが0になるまで行動不能
   - ⚠️ ランダム要素（1〜3ターン）

4. **こおり**
   - ✅ 行動不能状態
   - ⚠️ 20%回復（確率的テストのため複数回実行推奨）

### 統合テスト
- 複数状態異常の同時付与（通常は不可、上書きされる）
- 特性による無効化・変更
- 技による治療・付与

---

## 既知の制限事項

### 未実装項目
- ねむりターン数のランダム決定（現在はテスト用に固定値設定）
- こおり状態のほのお技による即座解除
- 特性による状態異常無効化（一部のみ実装済み）

### 今後の拡張ポイント
- 技による状態異常付与（でんじは、おにび、ねむるなど）
- 状態異常回復技（なおす、ラムのみなど）
- 特性との相互作用（ふしぎなうろこ、こんじょうなど）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-01 | 初版作成。まひ、やけど、ねむり、こおりの実装完了 |
| 2026-02-01 | 乱数使用ルール追加（battle.random使用を明記）。テスト用確率制御機能追加 |

---

## 関連ドキュメント

- [実装コード: src/jpoke/handlers/ailment.py](../../src/jpoke/handlers/ailment.py)
- [データ定義: src/jpoke/data/ailment.py](../../src/jpoke/data/ailment.py)
- [テストコード: tests/ailment.py](../../tests/ailment.py)
- [ダッシュボード: dashboard.json](../../dashboard.json)
