# 複雑条件分岐特性の詳細リサーチ

## 分析対象特性（10種）
複雑な条件分岐、複数の相互作用、ステートフル処理が必要な特性

---

## 1. 🔴 かがくへんかガス

### 効果
- 場にいる間、他の特性の効果が発動しなくなる
- 自分自身の特性も含めて無効化される
- 場から退場する瞬間に他の特性が復活

### 複雑な条件分岐
1. **場の状態管理**
   - 「かがくへんかガス」使用ポケモンが場に存在するか判定
   - 複数体いる場合の処理（AND条件で全特性無効化）

2. **タイミング問題**
   - 交代時: 退場ポケモンの特性確認 → 入場ポケモンの特性確認
   - 退場 → オーラ・フィールド復活 → 入場の順序

3. **特殊な特性への対応**
   - `undeniable`フラグ: かがくへんかガスでも無効化できるか？
   - 実装ルール: **無効化可能**（ポケモンの仕様）

4. **相互作用**
   - かがくへんかガス vs かがくへんかガス（同じ相手）→ どちらも無効
   - かがくへんかガス vs その他オーラ系（ダークオーラ等）→ 全て無効

### 実装上の課題
```
【状態】場にかがくへんかガスあり
├─ すべてのON_SWITCH_INハンドラをスキップ
├─ すべてのON_CALC_*ハンドラをスキップ
├─ オーラ・フィールド効果を無視
└─ 状態異常フラグ効果は通常通り（特性ではなく状態）

【状態】かがくへんかガス退場
└─ 他ポケモンの特性を再度有効化（リバースイベント必要）
```


---

## 2. 🔴 ムラっけ

### 効果
毎ターンいずれかのステータスが1段階下がり、2段階上がる
- 対象: A, B, C, D, S, 命中, 回避の7つ
- 各ターン1回のみ

### 複雑な条件分岐
1. **ランダム選択**
   - どのステータスを選ぶか: ランダム
   - ただし同じステータスを選ぶこともある
   - 上限チェック: 6段階（＋2した後に確認）

2. **タイミング**
   - 実行ターン: ターン終了時（ON_TURN_END）
   - 複数体がムラっけ持ちの場合: 順番？ランダム？

3. **状態の保持**
   - 1ターンに1回のみ発動
   - 交代による「ターンリセット」の処理

4. **上限チェック**
   ```
   選択ステータスX:
   ├─ X: -1 (下限-6まで)
   └─ Y（別選択）: +2 (上限+6まで)
   ```

5. **相互作用**
   - あまのじゃく: ムラっけの−1と+2が反転される
   - たんじゅん: ±の変化量が2倍に？
   - てんねん: ムラっけは自分への作用だから影響なし

---

## 3. 🟠 ダウンロード

### 効果
場に出たとき、相手のステータスに応じてこうげきかとくこうが1段階上がる
- 相手の B > D の場合: C を上げる
- 相手の D > B の場合: A を上げる
- 相手の B = D の場合: ?（実装によって異なる可能性）

### 複雑な条件分岐
1. **比較ロジック**
   ```
   相手のB vs D
   ├─ B > D  → 相手の特殊防御が低い → こちらは特攻C を上げる
   ├─ D > B  → 相手の物理防御が低い → こちらは攻撃A を上げる
   └─ B = D  → 同じ場合の処理（どちらにする？）
   ```

2. **複数の相手がいる場合**
   - ダブルバトル: 相手2体の場合？
   - 実装ルール: **自分の前の相手を参照**

3. **交代時の処理**
   - 同じポケモンが何度も出し入れ
   - 毎回ダウンロードが発動するか？
   - フラグ管理: `one_time` の有無確認

4. **レート上限チェック**
   - 上昇分が既に+6の場合、追加上昇なし

---

## 4. 🟡 かちき

### 効果
敵から能力を下げられたとき、とくこうが2段階上がる

### 複雑な条件分岐
1. **「下げられた」の判定**
   - 誰が下げたか: 敵のわざ、敵の特性か
   - 自分が下げた場合（あまのじゃくで反転）: どう扱う？
   - ランク補正全般が下がった場合のみ

2. **ランク低下の検出**
   - イベント: `ON_MODIFY_STAT`で`value < 0`の場合
   - フィルタリング: `source_spec="source:foe"`

3. **複数ランク低下の処理**
   - ひきずりおろす（A, B, Cが同時に-1）
   - 1回のイベントで複数ランク低下 vs 複数イベント
   - 実装ルール: **イベント1回につき、ステータスが下げられたら発動**

4. **相互作用**
   - クリアボディ: ランク低下が防止される → かちきは発動しない
   - ミラーアーマー: ランク低下が跳ね返される → かちきは発動するか？
   - あまのじゃく: 敵の「上げる」が「下げ」に反転 → かちき発動か？

---

## 5. 🟡 まけんき

### 効果
敵から能力を下げられたとき、こうげきが2段階上がる

### 複雑な条件分岐
**かちきとほぼ同じ**が、ステータスが異なる：
- かちき: C が上がる（特攻）
- まけんき: A が上がる（攻撃）

### 特別な相互作用
- ビシバシ（シンオウ図鑑外）: 対象外
- クリアボディ系: 同じく発動しない

---

## 6. 🟠 ばけのかわ

### 効果
1回だけ攻撃技のダメージを無効化する。発動すると最大HPの1/8が減少する

### 複雑な条件分岐
1. **1回限定の管理**
   ```
   初期状態: 保護層 ON
   ├─ 攻撃技を受ける → 保護層が無効化
   │  ├─ 実際のダメージ: 0
   │  └─ HP消費: 最大HPの1/8
   └─ 保護層が剥がれたら以降発動しない
   ```

2. **「攻撃技」の判定**
   - 直接攻撃 ✅
   - 特殊攻撃 ✅
   - 変化技 ❌
   - わざわいのことば（状態変化わざ）❌

3. **タイミング**
   - ダメージ計算前に判定
   - ダメージ0にしてからHP消費

4. **複数回のダメージ**
   ```
   ばけのかわ状態でマルチヒット技（れんぞくぎり3回）を受ける
   ├─ 1ヒット目: 無効化 → 保護層発動 → HP1/8消費
   └─ 2-3ヒット目: 通常ダメージ
   ```

5. **交代による復活**
   - 交代して戻ってきた: 保護層は復活するか？
   - 実装ルール: **復活する**

6. **相互作用**
   - マジックガード: ばけのかわのHP消費を防ぐか？
     - 実装ルール: **防ぐ**（ばけのかわのHP消費は「攻撃以外」と見なされる）

### 実装上の課題
```python
class BakenoKawa:
    active: bool = True  # ポケモン単位
    
    def on_take_damage(pokemon, damage, move):
        if not move.is_attack():  # 攻撃技判定
            return damage
        
        if not pokemon.bake_no_kawa_active:
            return damage
        
        # 保護層発動
        pokemon.hp -= pokemon.hp_max // 8  # 1/8消費
        pokemon.bake_no_kawa_active = False
        return 0  # ダメージ無効化
```

---

## 7. 🟢 シンクロ

### 効果
どく・もうどく・まひ・やけど状態になったとき、相手も同じ状態異常にする

### 複雑な条件分岐
1. **対応する状態異常**
   - どく ✅
   - もうどく ✅
   - まひ ✅
   - やけど ✅
   - その他（ねむり、こんらん等）❌

2. **相手が既に別の状態異常の場合**
   ```
   自分: やけど状態（シンクロで敵へも伝染）
   敵: すでにねむり状態
   
   → 複数状態異常の処理（ゲーム仕様で1つのみ）
   ```

3. **タイミング**
   - 自分が状態異常になった瞬間に敵へ伝染
   - わざで状態異常にされた場合のみ？
   - 実装ルール: **全ての状態異常適用イベントで発動**

4. **相互作用**
   - クリアボディ: 敵に状態異常がつかない → シンクロも発動しない
   - めんえき: 敵が毒免疫 → シンクロで毒がつかない
   - シンクロ vs シンクロ: 相互伝染ループ？
     - 実装ルール: **2段階までのみ伝染**

---

## 8. 🟡 じょうきかん

### 効果
みずタイプかほのおタイプのわざを受けるとすばやさが6段階上がる

### 複雑な条件分岐
1. **わざタイプの判定**
   - 与えるわざのタイプがみずまたはほのお
   - タイプ変更特性（ノーマルスキン等）の影響
   - 実装ルール: **変更後のタイプで判定**

2. **「受ける」のタイミング**
   - ダメージ計算後？前？
   - 無効化されたわざでも発動するか？
   - 実装ルール: **ダメージが0でも発動**（例：みずタイプが水技受けてちくでんで無効化）

3. **6段階上昇**
   - 通常は上限+6
   - 既に+1の場合: +6 → 実質+5になるか、それとも+6でカンスト？
   - 実装ルール: **+6で上限（加算ではなく上限適用）**

4. **複数回発動**
   - 同じポケモンから複数のわざを受ける
   - 毎回6段階上昇するか、1ターン1回制限があるか
   - 実装ルール: **毎回発動**

---

## 9. 🟡 そうだいしょう

### 効果
場に出たときに、ひんしになった味方1体につき10%ずつ攻撃技の威力が上がる

### 複雑な条件分岐
1. **ひんしポケモン数のカウント**
   ```
   味方3体中2体ひんし
   └─ 威力が20%上がる（10% × 2体）
   ```

2. **「攻撃技」の定義**
   - 物理技（直接攻撃のみ）
   - 特殊技も含む？
   - 実装ルール: **全ての攻撃技**（物理＋特殊）

3. **適用タイミング**
   - わざ選択時 vs ダメージ計算時
   - 実装ルール: **ダメージ計算時**

4. **複数身代わりやブーストエナジー**
   - 同条件で他の威力補正と積算
   - 乗算か加算か？
   - 実装ルール: **乗算**（ダメージ計算の通常順序）

---

## 10. 🟡 へんしょく

### 効果
受けた攻撃技と同じタイプになる

### 複雑な条件分岐
1. **「攻撃技」の判定**
   - 変化技 ❌
   - ダメージ0の攻撃 ✅（例：ドレインパンチ）
   - 無効化された攻撃 ✅（例：みずタイプがでんきわざ受けてちくでん無効化）

2. **わざのタイプ取得**
   - 元のタイプ or 変更後のタイプ
   - 実装ルール: **変更後のタイプ**
   - 例: ノーマルスキンで変わったノーマル技 → ノーマルタイプになる

3. **タイプ変化のタイミング**
   - ダメージ受けた直後
   - 複数体からの攻撃を同時に受ける場合（ダブル）
   - 実装ルール: **最後に受けた攻撃のタイプ**

4. **既存タイプ**
   ```
   元のタイプ: みず/ひこう型
   へんしょくで みずわざ を受ける
   新しいタイプ: みず単一型？ (通常は単一になる)
   ```

---

## 11. 🟢 ダークオーラ / フェアリーオーラ

### 効果
- ダークオーラ: 場にいるポケモンのあくわざの威力が1.33倍になる
- フェアリーオーラ: 場にいるポケモンのフェアリーわざの威力が1.33倍になる

### 複雑な条件分岐
1. **「場にいる」の定義**
   - ダークオーラ持ち: 敵味方関係なく全員に効果
   - 複数のダークオーラ: 積算するか？
   - 実装ルール: **複数あっても1.33倍のみ**

2. **わざのタイプ判定**
   - 変更後のタイプで判定
   - 例: エレキスキンででんきタイプになったノーマル技 → でんき技扱い

3. **交代時の再計算**
   - ダークオーラ持ちが交代する
   - 全体オーラの再計算不要（ダメージ計算時に確認）

4. **複合タイプ**
   ```
   わざ: あく/フェアリー（存在しない）
   ダークオーラ + フェアリーオーラ
   → 両方が適用されるか？
   ```

---

**最終更新**: 2026年2月4日  
**リサーチ完了**: 全10特性の複雑条件分岐を詳細分析
