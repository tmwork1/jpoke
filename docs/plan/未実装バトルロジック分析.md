# 未実装バトルロジック・イベント分析

**作成日**: 2026年2月4日  
**対象**: 第9世代（SV）シングル対戦  
**目的**: 技・特性実装に必要な欠けているバトルロジックとイベントの洗い出し

---

## エグゼクティブサマリー

### 実装状況概要

| カテゴリ | 総数（推定） | 実装済み | 未実装 | 実装率 |
|---------|-------------|---------|--------|--------|
| **技** | 759 | ~20 | ~740 | 2.6% |
| **特性** | ~300 | ~15 | ~285 | 5.0% |
| **持ち物** | ~200 | ~45 | ~155 | 22.5% |
| **フィールド効果** | ~30 | ~25 | ~5 | 83.3% |
| **状態異常** | 8 | 8 | 0 | 100% |
| **揮発状態** | ~50 | ~18 | ~32 | 36.0% |
| **イベントハンドラ** | ~500 | ~50 | ~450 | 10.0% |

---

## 1. 【最優先】未実装の核心バトルロジック

### 1.1 ダメージ計算関連（重要度: ★★★★★）

#### 欠けているロジック

1. **急所判定システム**
   - 現状: 未実装
   - 必要性: 多数の技（約40技）が急所率アップを持つ
   - 実装箇所: `core/damage.py`
   - 必要イベント: `ON_CALC_CRITICAL`（新規）
   - 影響技例: `いわなだれ`, `エアカッター`, `つじぎり`, `サイコカッター`

2. **タイプ相性計算の完全実装**
   - 現状: 基本実装済みだが、特殊ケースが未対応
   - 必要性: 一撃必殺技、ふゆう無効化など
   - 実装箇所: `core/damage.py`
   - 特殊ケース:
     - ふしぎなまもり（等倍以下無効）
     - じめんタイプの浮遊無効化
     - フリーズドライ（みずタイプへのこおり抜群）

3. **乱数補正（0.85～1.00の倍率）**
   - 現状: 実装済み（damage.pyで確認）
   - 検証: 要テスト確認

4. **特殊ダメージ計算式**
   - けたぐり・くさむすび（相手の重さ依存）
   - ジャイロボール（相手の素早さ依存）
   - エレキボール（相手の素早さ依存）
   - ヘビーボンバー（相手の重さ依存）
   - イカサマ（相手の攻撃力使用）
   - レベルボール（レベル差依存）
   - 実装箇所: `core/damage.py` または個別技ハンドラ
   - 必要データ: ポケモンの体重情報（`model/pokemon.py`に追加）

### 1.2 命中判定システム（重要度: ★★★★★）

#### 欠けているロジック

1. **命中率・回避率ランク補正**
   - 現状: ランク変化自体は実装済み（`model/stats.py`）
   - 必要性: 命中率・回避率を変更する技が約20技存在
   - 実装箇所: `core/move_executor.py`
   - ランク補正表:
     - -6: ×3/9, -5: ×3/8, -4: ×3/7, -3: ×3/6
     - -2: ×3/5, -1: ×3/4, 0: ×3/3, +1: ×4/3
     - +2: ×5/3, +3: ×6/3, +4: ×7/3, +5: ×8/3, +6: ×9/3

2. **必中技の処理**
   - 現状: accuracy=999などで暫定対応
   - 必要性: `つばめがえし`, `スマートホーン`, `かげぬい`など
   - 実装: `ON_CALC_ACCURACY`で命中率チェックをスキップ

3. **特殊命中条件**
   - ロックオン・こころのめ使用時の必中化
   - じゅうりょく時の命中率5/3倍
   - 天候による命中率変化（はれ時のかみなり・ぼうふう50%）
   - 実装箇所: `ON_CALC_ACCURACY`イベント

### 1.3 行動順序決定システム（重要度: ★★★★★）

#### 欠けているロジック

1. **優先度システムの完全実装**
   - 現状: 部分実装（`core/speed_calculator.py`）
   - 必要性: 約50技が優先度±を持つ
   - 優先度範囲: -7 ～ +5
   - 主要優先度:
     - +5: てだすけ
     - +4: まもる、みきり、キングシールド
     - +3: しんそく、ノーマルジュエル版でんこうせっか
     - +2: こおりのつぶて、マッハパンチ、アクセルロック
     - +1: でんこうせっか、アクアジェット、かげうち
     - -1: あてみなげ
     - -3: きあいパンチ
     - -4: ゆきなだれ、カウンター、ミラーコート
     - -5: トラップシェル
     - -6: ともえなげ、ドラゴンテール
     - -7: ほえる、ふきとばし

2. **同速時のランダム処理**
   - 現状: 未実装
   - 必要性: 競合時の公平性
   - 実装: `core/speed_calculator.py`

3. **クイックドロウ・せんせいのツメ・イバンのみ**
   - 現状: 未実装（event_gen9.mdに記載あり）
   - 必要性: 20%確率で優先度+1相当
   - 実装箇所: `ON_BEFORE_ACTION`イベント

### 1.4 特殊状態管理（重要度: ★★★★☆）

#### 欠けているロジック

1. **一撃必殺技**
   - 技: `つのドリル`, `ハサミギロチン`, `じわれ`, `ぜったいれいど`
   - 無効条件: レベル差、がんじょう特性、ダイマックス
   - 命中率: 30% + (使用者Lv - 対象Lv)
   - 実装: 専用ダメージ計算ロジック

2. **HP比率依存技**
   - がむしゃら（相手HPを自分HP以下に）
   - いのちがけ（自分のHPと同じダメージ、使用者ひんし）
   - じたばた・きしかいせい（残HP依存で威力変動）
   - 実装: `ON_CALC_POWER`またはダメージ計算内

3. **みがわり貫通判定**
   - 現状: みがわりシステム自体が未実装
   - 貫通技: 音技全般、フェイント、ほえる等
   - 実装: `ON_TRY_IMMUNE`での判定

4. **姿を隠す状態**
   - そらをとぶ、あなをほる、ダイビング、ゴーストダイブ
   - 溜めターンは無敵、特定技のみ命中
   - 実装: 揮発状態として管理 + `ON_TRY_IMMUNE`

### 1.5 PP管理（重要度: ★★★☆☆）

#### 欠けているロジック

1. **PP増減イベント**
   - げんしのちから（ランク+1ボーナス時PP-1）
   - おんねん（倒された時に相手のPP全消費）
   - うらみ（直前技のPP-4）
   - ぶきみなじゅもん（被弾後PP-3）
   - 実装: `ON_DAMAGE_1`, `ON_DAMAGE_2`での処理

2. **こだわり系アイテムの技固定**
   - こだわりハチマキ・メガネ・スカーフ
   - 一度技を使うと、交代するまで同じ技しか使えない
   - 実装: `ON_TRY_MOVE` Priority 10での判定

---

## 2. 【高優先】技の追加効果実装に必要なロジック

### 2.1 能力ランク変化（重要度: ★★★★★）

#### 実装状況
- 基本機能: ✅ 実装済み（`common.modify_stat`）
- 確率発動: ✅ 実装済み（`prob`パラメータ）
- 段階変化: ✅ 実装済み（`v`パラメータで-2, +2対応）

#### 未実装ケース

1. **能力ランク依存条件**
   - アシストパワー（自分のランク上昇合計×20が威力）
   - あばれる・はなびらのまい（2-3ターン連続、終了後こんらん）
   - 実装: 技個別のロジック

2. **能力変化の無効化条件**
   - クリアボディ・しろいきり（能力低下無効）
   - かいりきバサミ（攻撃低下無効）
   - するどいめ（命中率低下無効）
   - Priority 140での判定（`ON_TRY_MOVE`）

### 2.2 状態異常付与（重要度: ★★★★☆）

#### 実装状況
- 基本システム: ✅ 完全実装
- 特性による無効化: ✅ 実装済み（`ON_BEFORE_APPLY_AILMENT`）
- フィールドによる無効化: ✅ 実装済み

#### 未実装ケース

1. **複合状態異常技**
   - フェイタルクロー（50%でどく・まひ・やけどのいずれか）
   - トライアタック（20%でまひ・やけど・こおりのいずれか）
   - 実装: 技個別ハンドラで複数判定

2. **状態異常の相互作用**
   - ねむり中のあばれる技中断
   - こおり状態をほのお技で治す
   - 実装済み: `ON_DAMAGE_2`（一部）
   - 要実装: あばれる中断ロジック

### 2.3 HP操作系（重要度: ★★★★☆）

#### 未実装ロジック

1. **HP吸収技**
   - 現状: 基本実装あり（`ON_HIT`での回復）
   - 問題点: ヘドロえき特性（吸収→ダメージ反転）未実装
   - リスト: きゅうけつ、メガドレイン、ギガドレイン、ドレインパンチ等（約12技）
   - 実装: `ON_HIT` Priority 20での処理

2. **反動ダメージ**
   - 現状: いのちのたまのみ実装済み
   - 未実装: 技自体の反動（すてみタックル等）
   - リスト: 約13技（33%反動）+ 4技（失敗時50%反動）
   - 実装: `ON_DAMAGE_2` Priority 100

3. **HPコスト技**
   - じばく・だいばくはつ（使用後ひんし）
   - クロロブラスト等（最大HPの50%消費）
   - 実装: `ON_PAY_HP`イベント

4. **回復技**
   - じこさいせい、ねむる、つきのひかり等
   - 現状: 一部実装（ねむるはテスト確認）
   - 実装: `ON_TRY_IMMUNE`での失敗判定 + HP回復処理

### 2.4 特殊効果（重要度: ★★★★☆）

#### 未実装ロジック

1. **ひるみ**
   - 約37技がひるみ効果を持つ
   - 条件: 後攻時のみ発動
   - 無効: せいしんりょく特性
   - 実装: `ON_TRY_ACTION` Priority 40

2. **混乱（こんらん）**
   - 現状: ✅ 完全実装済み（`test_volatile.py`で確認）
   - 技数: 約14技

3. **交代強制技**
   - ほえる、ふきとばし、ドラゴンテール、ともえなげ
   - 現状: ✅ 実装済み（`move.py`で`blow`ハンドラ確認）
   - テスト: 未実装

4. **ピボット技（攻撃後交代）**
   - とんぼがえり、ボルトチェンジ、クイックターン、すてゼリフ
   - 現状: ✅ 実装済み（`pivot`ハンドラ）
   - テスト: 一部あり（`test_move.py`）

---

## 3. 【中優先】特性実装に必要なロジック

### 3.1 場に出た時発動特性（重要度: ★★★★☆）

#### 未実装の主要特性

1. **天候・フィールド設置**
   - あめふらし、ひでり、すなおこし、ゆきふらし
   - エレキメイカー、グラスメイカー、サイコメイカー、ミストメイカー
   - 現状: フィールドシステムは実装済み
   - 必要処理: `ON_SWITCH_IN`でフィールド設置
   - Priority: 100

2. **いかく（攻撃-1）**
   - 現状: ✅ 実装済み（`ability.py`で確認）
   - テスト: ✅ あり

3. **ダウンロード（相手の低い防御を判定して特攻or攻撃+1）**
   - 実装: `ON_SWITCH_IN` Priority 100
   - 必要ロジック: 相手の防御・特防比較

4. **トレース（相手の特性コピー）**
   - 実装難易度: 高
   - 必要ロジック: 特性の動的変更システム

### 3.2 ダメージ計算時特性（重要度: ★★★★☆）

#### 未実装の主要特性

1. **タイプ無効化吸収特性**
   - ちょすい・かんそうはだ（みず無効→回復）
   - もらいび（ほのお無効→炎技威力1.5倍）
   - ひらいしん・でんきエンジン（でんき無効→特攻/素早さ+1）
   - そうしょく（くさ無効→攻撃+1）
   - 実装: `ON_TRY_MOVE` Priority 110

2. **ダメージ軽減特性**
   - マルチスケイル・ファントムガード（HP満タン時ダメージ半減）
   - ハードロック・フィルター（抜群ダメージ0.75倍）
   - いかりのこうら（HP50%以下で防御/特防-1、攻撃/特攻/素早さ+1）
   - 実装: `ON_CALC_DAMAGE_MODIFIER`

3. **ダメージ増加特性**
   - てつのこぶし（パンチ技1.2倍）
   - すてみ（反動技1.2倍）
   - メガランチャー（波動技1.5倍）
   - 実装: `ON_CALC_POWER_MODIFIER`

### 3.3 状態異常関連特性（重要度: ★★★☆☆）

#### 実装状況
- 無効化: ✅ ほぼ実装済み（めんえき、ふみん等）
- 未実装: シンクロ、ポイズンヒール

1. **シンクロ（状態異常を相手にも付与）**
   - 実装: `ON_DAMAGE_1` Priority 20

2. **ポイズンヒール（どく状態時、ターン終了時に回復）**
   - 実装: `ON_TURN_END_3` Priority 30

3. **はやあし（状態異常時に素早さ1.5倍）**
   - 実装: `ON_CALC_SPEED`

---

## 4. 【中優先】持ち物実装に必要なロジック

### 4.1 未実装の重要アイテム

#### 回復きのみ（重要度: ★★★☆☆）

1. **オボンのみ（HP50%以下で25%回復）**
   - 現状: `return False`のみ
   - 実装: `ON_BEFORE_ACTION`または`ON_DAMAGE_2` Priority 170

2. **HP回復きのみ（オレン、フィラ等）**
   - 発動条件: HP50%以下または特定HP閾値
   - 実装: `ON_DAMAGE_2` Priority 170

3. **キーのみ（こんらん回復）**
   - 現状: 未実装（`return False`）
   - 必要: こんらん状態の治癒処理

#### 能力上昇きのみ（重要度: ★★☆☆☆）

1. **チイラのみ等（HP25%以下で能力+1）**
   - チイラ（攻撃+1）、リュガ（防御+1）、カムラ（素早さ+1）等
   - 実装: `ON_DAMAGE_2` Priority 170

#### 特殊アイテム（重要度: ★★★★☆）

1. **こだわり系（ハチマキ・メガネ・スカーフ）**
   - 効果: 能力1.5倍だが、技固定
   - 実装:
     - 能力補正: `ON_CALC_POWER_MODIFIER`（ハチマキ・メガネ）
     - 素早さ補正: `ON_CALC_SPEED`（スカーフ）
     - 技固定: `ON_TRY_MOVE` Priority 10

2. **きあいのタスキ（HP満タン時、瀕死ダメージでもHP1残し）**
   - 実装: `ON_MODIFY_DAMAGE` Priority 100

3. **きあいのハチマキ（10%確率でHP1残し）**
   - 実装: `ON_MODIFY_DAMAGE` Priority 100

4. **とつげきチョッキ（特防1.5倍、変化技使用不可）**
   - 特防補正: `ON_CALC_SPDEF`
   - 技制限: `ON_TRY_MOVE`

---

## 5. 【低優先】未実装の揮発状態

### 5.1 未実装の主要揮発状態（重要度: ★★☆☆☆）

1. **みがわり**
   - HP1/4消費してみがわり設置
   - 音技・一部技以外を無効化
   - 実装: `ON_TRY_IMMUNE` Priority 30

2. **あばれる状態（はなびらのまい、げきりん等）**
   - 2-3ターン連続攻撃後、こんらん
   - 実装: ターンカウンタ + `ON_TURN_END_4`

3. **アンコール（直前技を3ターン繰り返す）**
   - 実装: `ON_BEFORE_MOVE`での技強制

4. **やどりぎのタネ（ターン終了時に1/8吸収）**
   - 実装: `ON_TURN_END_3` Priority 20

5. **のろい（ゴーストタイプ使用時）**
   - 自分のHP半減、相手に1/4ダメージを毎ターン
   - 実装: `ON_TURN_END_3` Priority 60

6. **まもる系技（みきり、キングシールド、ニードルガード等）**
   - 実装: `ON_TRY_MOVE` Priority 100
   - 連続使用で成功率低下ロジック必要

---

## 6. 【低優先】複雑な技の個別実装

### 6.1 2ターン技（重要度: ★★☆☆☆）

- そらをとぶ、あなをほる、ダイビング、ゴーストダイブ
- ソーラービーム、メテオビーム等
- 実装: 揮発状態でターン管理 + パワフルハーブ対応

### 6.2 連続攻撃技（重要度: ★★☆☆☆）

- おうふくビンタ、タネマシンガン等（2-5回）
- ダブルアタック、ダブルチョップ等（2回確定）
- 実装: 攻撃回数判定ロジック

### 6.3 特殊計算技（重要度: ★★★☆☆）

既に1.4で記載済み（けたぐり、ジャイロボール等）

---

## 7. イベント実装優先順位マトリクス

### 最優先（★★★★★）

| イベント | 現状 | 必要処理数 | 影響範囲 |
|---------|------|-----------|---------|
| ON_CALC_CRITICAL | 未定義 | 1 | 約40技 |
| ON_CALC_ACCURACY（完全版） | 部分実装 | ~30 | 全技 |
| ON_CALC_SPEED（完全版） | 部分実装 | ~20 | 全体 |
| ON_TRY_ACTION | 部分実装 | ~30 | 行動可否 |
| ON_TRY_MOVE | 部分実装 | ~150 | 技使用可否 |

### 高優先（★★★★☆）

| イベント | 現状 | 必要処理数 | 影響範囲 |
|---------|------|-----------|---------|
| ON_TRY_IMMUNE | 部分実装 | ~100 | 無効化判定 |
| ON_MODIFY_DAMAGE | 部分実装 | ~7 | ダメージ軽減 |
| ON_HIT | 部分実装 | ~50 | 追加効果 |
| ON_DAMAGE_1 | 部分実装 | ~30 | 被弾時効果 |
| ON_DAMAGE_2 | 部分実装 | ~40 | 被弾後処理 |

### 中優先（★★★☆☆）

| イベント | 現状 | 必要処理数 | 影響範囲 |
|---------|------|-----------|---------|
| ON_SWITCH_IN | 部分実装 | ~100 | 場に出た時 |
| ON_TURN_END系 | 部分実装 | ~100 | ターン終了 |
| ON_PAY_HP | 未実装 | ~5 | HPコスト |
| ON_CALC_POWER | 未実装 | ~50 | 威力計算 |

---

## 8. 実装ロードマップ提案

### フェーズ1: 核心システム（2-3週間）

1. 急所判定システム（`ON_CALC_CRITICAL`）
2. 命中判定の完全実装（`ON_CALC_ACCURACY`拡張）
3. 行動順序決定の完全実装（優先度システム）
4. ひるみシステム
5. HP吸収・反動ダメージの完全実装

### フェーズ2: 技追加効果（3-4週間）

1. 能力ランク変化技の完全対応
2. HP操作系技（吸収、反動、コスト）
3. 特殊ダメージ計算技（けたぐり等）
4. 交代強制・ピボット技のテスト充実

### フェーズ3: 特性実装（4-5週間）

1. 場に出た時発動特性（天候・フィールド設置）
2. タイプ無効化吸収特性
3. ダメージ計算時特性
4. 状態異常関連特性

### フェーズ4: 持ち物実装（2-3週間）

1. 回復きのみ（オボン等）
2. こだわり系アイテム
3. きあいのタスキ・ハチマキ
4. 能力上昇きのみ

### フェーズ5: 揮発状態・複雑技（3-4週間）

1. みがわり
2. まもる系技
3. 2ターン技
4. 連続攻撃技
5. やどりぎのタネ、あばれる等

---

## 9. 技術的課題と解決策

### 9.1 データ不足

**課題**: ポケモンの体重情報がない  
**影響**: けたぐり、ヘビーボンバー等が実装不可  
**解決策**: `model/pokemon.py`に`weight`フィールド追加、`data/pokedex.py`にデータ追加

### 9.2 イベント不足

**課題**: 急所判定用のイベントが未定義  
**解決策**: `utils/enums/event.py`に`ON_CALC_CRITICAL`を追加

### 9.3 複雑な状態管理

**課題**: みがわり、あばれる、溜め技等の複数ターン状態管理  
**解決策**: 揮発状態にターンカウンタと追加データを保持する仕組みを拡張

### 9.4 特性の動的変更

**課題**: トレース、かわりもの等で特性が変わる  
**解決策**: `pokemon.current_ability`と`pokemon.original_ability`を分離

---

## 10. まとめ

### 実装すべき最重要項目（Top 10）

1. **急所判定システム** - 約40技に影響
2. **命中判定の完全実装** - 全技に影響
3. **優先度システムの完全実装** - 約50技に影響
4. **ひるみシステム** - 約37技に影響
5. **HP吸収技の完全実装** - 約12技に影響
6. **反動ダメージシステム** - 約17技に影響
7. **特殊ダメージ計算技** - 約10技に影響
8. **一撃必殺技** - 4技に影響
9. **こだわり系アイテム** - 対戦必須アイテム
10. **きあいのタスキ** - 対戦必須アイテム

### 完全実装への道のり

- **現在の実装率**: 約10-15%
- **フェーズ1-2完了時**: 約40-50%
- **フェーズ1-3完了時**: 約65-75%
- **フェーズ1-5完了時**: 約85-95%

完全実装には推定 **14-19週間**（3.5-5ヶ月）が必要と見込まれる。

---

**文書作成者**: COD (Coder)  
**最終更新**: 2026年2月4日
