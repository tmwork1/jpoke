# 実装計画 - 統合版

**作成日**: 2026年2月7日  
**最終更新**: 2026年2月7日  
**現在フェーズ**: フェーズ1-3（開始準備中）  
**全体期間**: 2026年2月～4月（8週間）

---

## 📊 進捗概要

### フェーズ1-2 の完了内容（✅ 完了）
| タスク | 成果 | テスト | 備考 |
|--------|------|--------|------|
| **急所判定システム** | イベント `ON_CALC_CRITICAL` 実装、ランク計算、ダメージ統合 | 5/5 Pass | 特性補正は1-3で実装 |
| **優先度システム** | 優先度計算式 (-7～+5)、50+技の優先度マッピング | 全Pass | 次シーズンシステムと統合済み |

**累積実装率**: 10%（特性15/163, 技81/759, アイテム22/160+）

### フェーズ1-3 の完了内容（✅ Week 1-2 完了）
| タスク | 成果 | テスト | 備考 |
|--------|------|--------|------|
| **命中判定システム** | ランク補正・天候補正の統合 | 11/11 Pass | 完全実装 |
| **ひるみシステム** | ひるみ付与・行動キャンセル・解除の統合 | - | 完全実装 |
| **HP吸収・反動** | apply_hp_drain, apply_recoil ハンドラ実装 | 8/8 Pass | きゅうけつ・すてみタックル実装 |

**フェーズ1-3進捗**: Week 1-2 基盤構築 **100% 完了**

---

## 🎯 次の実装タスク - 優先度順

### ⭐︎ 【最優先・即座】Week 1-4

#### 1. 命中判定システム （推定工数: 5日）
**影響範囲**: 659技が関わる（87%）  
**優先度**: 🔴 **CRITICAL** - これなしに技の動作検証不可

**実装内容**:
- 基本命中率計算（デフォルト100%）
- ランク補正: -6～+6で ×1/3～×3.0
- 天候補正（雨時かみなり→100%）
- 特性補正（ロックオン、レーダー等）
- 必中技処理（精度判定スキップ）

**対象ファイル**: 
- `src/jpoke/core/move_executor.py`
- `src/jpoke/handlers/move.py`

**参照**: [docs/spec/accuracy.md](../research/accuracy.md)

---

#### 2. ひるみシステム （推定工数: 2日）
**影響範囲**: 37技（いわなだれ等）

**実装内容**:
- 後攻ひるみ判定（確率判定）
- イベント挿入位置: `ON_TRY_ACTION` Priority 40
- 無効化特性対応（せいしんりょく等）
- 技フラグ `stun: {prob: xx}` の処理

---

#### 3. HP吸収・反動ダメージ （推定工数: 3.5日）
**影響範囲**: 29技（きゅうけつ、すてみタックル等）

**実装内容**:
- HP吸収率処理（1/2吸収等）
- ゼロ距離での反動ダメージ
- `on_hit` イベントで HP 回復・ダメージ処理

---

### ⭐︎ 【高優先】Week 4-6

#### 4. 特性実装 Phase 1 （推定工数: 6日）
**対象**: 45特性（タイプ強化・素早さ・付与・フィールド）

**グループ別タスク**:
- **タイプ別威力強化** (23種, 2日): てきおうりょく、てつのこぶし等
  - イベント: `ON_CALC_POWER_MODIFIER`
- **素早さ操作** (8種, 1.5日): すいすい、すなかき等
  - イベント: `ON_CALC_SPEED`
- **状態異常付与** (4種, 1日): どくしゅ、どくのトゲ等
  - イベント: `ON_HIT`
- **天候・フィールド設定** (10種, 1.5日): あめふらし、ひでり等
  - イベント: `ON_SWITCH_IN` Priority 100

**参照**: [docs/spec/abiity/ability_list.md](../research/abiity/ability_list.md)

---

#### 5. 技・アイテム実装 Phase 1 （推定工数: 4日）

**Task 5.1**: 能力ランク変化技 (80技, 1.5日)
- 既存 `common.modify_stat` を活用
- つるぎのまい、ストームスロー等

**Task 5.2**: 状態異常付与技 (60技, 1日)
- 複合状態異常対応
- 特性・フィールド無効化統合テスト

**Task 5.3**: こだわり系アイテム (3種, 1.5日)
- こだわりハチマキ、こだわりメガネ、こだわりスカーフ
- イベント: `ON_TRY_MOVE` Priority 10（技固定ロジック）

---

### ⭐︎ 【低優先・余力】Week 7-8

#### 6. 特殊計算技 （12技, 3日）
- けたぐり、くさむすび（体重依存）
- ジャイロボール、エレキボール（素早さ依存）
- ハードプレス（HP比率依存）

#### 7. 一撃必殺技 （4技, 1.5日）
- つのドリル、ハサミギロチン、じわれ、ぜったいれいど
- がんじょう・ダイマックス無効化対応

#### 8. ダメージ軽減特性 （8種, 2.5日）
- ハードロック、フィルター、プリズムアーマー等

---

## 📅 スケジュール

| 週 | タスク | 工数 | 目標達成度 |
|----|--------|------|-----------|
| **1-2** | 設計・仕様確認 | - | 実装開始準備 |
| **2-4** | 命中・ひるみ・吸収 | 10.5日 | 基盤完成 |
| **4-6** | 特性45種実装 | 6日 | 特性 9% → 37% |
| **6-7** | 技・アイテム | 4日 | 技 11% → 29% |
| **7-8** | 低優先（余力時） | 7日 | オプション |

**期間**: 8週間 | **推定総工数**: 27.5日 | **予想実装率**: 10% → **25%**

---

## 🎨 成果目標

### Phase 1-3 終了時点での想定状態

| カテゴリ | 現在 | 目標 | 進捗 |
|---------|------|------|------|
| **特性** | 15/163 (9%) | 60/163 (37%) | 45種追加 ✅ |
| **技** | 81/759 (11%) | 221/759 (29%) | 140種追加 ✅ |
| **アイテム** | 22/160 (14%) | 25/160 (16%) | 3種追加 ✅ |
| **命中判定** | ❌ 未実装 | ✅ 完成 | **Critical** |
| **全体実装率** | **10%** | **25%** | **2.5倍** |

---

## ⚠️ リスク・注意事項

| 項目 | 対策 |
|------|------|
| **命中判定のエッジケース** | Research で全パターン確認、期間延長可能 |
| **特性相互作用の複雑さ** | 段階的実装 + 統合テスト重視 |
| **進捗遅延** | Stage 4（低優先）を Phase 1-4 に延期 |

---

## 📖 参照ドキュメント

**詳細情報**:
- 技別影響分析: [docs/review/20260207_実装状況レビューレポート.md](../review/20260207_実装状況レビューレポート.md)
- 命中判定仕様: [docs/spec/accuracy.md](../research/accuracy.md)
- 特性リスト: [docs/spec/abiity/ability_list.md](../research/abiity/ability_list.md)
- 技データ: [docs/spec/move/](../research/move/)

---

## 🚀 次の実装ステップ（即座）

**当面のアクション**:
1. **命中判定システムの仕様確認** (本日・明日)
   - [docs/spec/accuracy.md](../research/accuracy.md) で全エッジケース確認
   - 依存する特性・アイテム一覧の整理
2. **実装開始** (Week 1)
   - `src/jpoke/core/move_executor.py` の命中判定メインロジック実装
3. **ひるみシステム設計** (並行)
   - `ON_TRY_ACTION` の割り込み位置を確認
   - テスト対象の洗い出し

---

**Status**: 🟢 **Ready for Implementation**  
**Next Review**: Week 2 進捗確認
